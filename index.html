<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Input Toko</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            background-color: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .form-container {
            padding: 30px;
            position: relative;
            max-width: 1400px;
            margin: 0 auto;
        }

        .main-layout {
            display: flex;
            gap: 5px;
            align-items: flex-start;
        }

        .left-section {
            flex: 1;
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            min-width: 0;
        }

        .right-section {
            flex: 1;
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        /* Ensure log container takes available space */
        .log-container {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }

        /* Ensure log actions stay at bottom */
        .log-actions {
            margin-top: auto;
            flex-shrink: 0;
        }

        .form-row {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
        }

        .form-column {
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input::placeholder, .form-group textarea::placeholder {
            color: #999;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            transition: all 0.3s ease;
        }

        .form-group textarea.auto-resize {
            min-height: 80px;
            height: auto;
            overflow: hidden;
        }



        /* Popup styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .popup-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .toko-list {
            display: grid;
            gap: 15px;
        }

        .toko-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .toko-item:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .toko-nama {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .toko-alamat {
            color: #666;
            line-height: 1.5;
            white-space: pre-line;
            font-size: 14px;
        }

        .show-list-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0;
            min-width: 180px;
            position: relative;
            overflow: hidden;
        }

        .show-list-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .show-list-btn:hover::before {
            left: 100%;
        }

        .show-list-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .show-list-btn:active {
            transform: translateY(-1px);
        }

        .show-list-btn.hidden {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .show-list-btn.hidden:hover {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-add {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
            position: relative;
            overflow: hidden;
        }

        .btn-add::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-add:hover::before {
            left: 100%;
        }

        .btn-add:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-add:active {
            transform: translateY(-1px);
        }

        .btn-add.hidden {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-add.hidden:hover {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .toggle-buttons-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        }

        .toggle-buttons-btn.right-section {
            position: relative;
            top: auto;
            right: auto;
            margin-bottom: 20px;
            width: 100%;
        }

        .toggle-buttons-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(111, 66, 193, 0.4);
        }

        .toggle-buttons-btn:active {
            transform: translateY(0);
        }



        /* Container baru untuk tombol utama */
        .main-actions-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .main-actions-container.hidden {
            display: none;
        }

        .main-actions-container:not(.hidden) {
            display: block;
            animation: slideIn 0.3s ease-out;
        }



        .main-actions-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Action buttons styles */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
        }

        .btn-edit {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .btn-delete {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .btn-edit:hover, .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        .btn-edit:active, .btn-delete:active {
            transform: translateY(0);
        }

        /* Autocomplete styles */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }

        .autocomplete-item.selected {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .autocomplete-item-icon {
            font-size: 16px;
            color: #666;
        }

        .autocomplete-item-text {
            flex: 1;
        }

        .autocomplete-item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .autocomplete-item-address {
            font-size: 12px;
            color: #666;
            line-height: 1.3;
        }

        .no-results {
            padding: 16px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        /* Input field dengan icon */
        .input-with-icon {
            position: relative;
            width: 100%;
        }

        .input-with-icon input {
            padding-right: 45px;
        }

        .input-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            color: #666;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-icon:hover {
            background-color: #f0f0f0;
            color: #333;
            transform: translateY(-50%) scale(1.1);
        }

        .input-icon:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Form modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        /* Ensure Edit Toko modal overlays above Quick Add modal */
        #quickAddModalOverlay {
            z-index: 2000; /* base */
        }
        #modalOverlay {
            z-index: 3000; /* above quick add */
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal.quick-add {
            max-width: 500px;
            width: 90%;
            padding: 20px;
        }

        .modal.quick-add .modal-title {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .modal.quick-add .modal-form {
            gap: 15px;
        }

        .modal.quick-add .modal-form input,
        .modal.quick-add .modal-form textarea {
            padding: 12px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }

        .modal.quick-add .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal.quick-add .btn-save,
        .modal.quick-add .btn-cancel {
            padding: 10px 20px;
            font-size: 14px;
            min-width: 80px;
        }

        /* Quick Tabs Styles */
        .quick-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-btn.active {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tab-btn:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }

        .tab-content {
            position: relative;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Quick List Styles */
        .quick-list-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .quick-list-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .quick-list-header h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }

        .quick-list-header p {
            margin: 0;
            color: #666;
            font-size: 13px;
        }

        .quick-toko-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quick-toko-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-toko-item:hover {
            background: #e9ecef;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        .quick-toko-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .quick-toko-address {
            color: #666;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-line;
        }

        /* Actions inside quick list items */
        .quick-toko-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-toko-item .btn-edit,
        .quick-toko-item .btn-delete {
            padding: 6px 10px;
            min-width: auto;
            font-size: 12px;
        }

        /* Inline field warning (e.g., for duplicate No. SJ) */
        .field-warning {
            color: #dc3545;
            font-size: 12px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .has-warning {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        /* Container Data Kaca Styles */
        .kaca-data-container {
            background: white;
            border-radius: 16px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            width: 100%;
        }

        .kaca-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .kaca-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        .btn-refresh-page {
            background: linear-gradient(135deg, #0dcaf0 0%, #0d6efd 100%);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-refresh-page:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(13, 110, 253, 0.25);
        }

        .kaca-controls {
            display: flex;
            gap: 10px;
        }

        .btn-add-row, .btn-remove-row {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-print {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .kaca-controls .btn-print-now {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove-row {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-add-row:hover, .btn-remove-row:hover, .btn-print:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .kaca-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .kaca-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .kaca-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            font-weight: 600;
            padding: 15px 12px;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            font-size: 14px;
        }

        .kaca-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            vertical-align: middle;
        }

        .kaca-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .kaca-table tbody tr {
            transition: background-color 0.3s ease;
        }

        .kaca-table input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            text-align: left;
            transition: border-color 0.3s ease;
        }

        .kaca-table input[type="number"] {
            -moz-appearance: textfield;
        }

        .kaca-table input[type="number"]::-webkit-outer-spin-button,
        .kaca-table input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .kaca-table .box-input {
            position: relative;
        }

        .kaca-table .box-input input {
            padding-right: 25px;
        }

        .kaca-table .box-input::after {
            content: "";
            position: absolute;
            right: 70px;
            top: 49%;
            transform: translateY(-50%);
            color: #666;
            font-size: 12px;
            font-weight: 500;
            pointer-events: none;
        }

        .kaca-table .lbr-input {
            position: relative;
        }

        .kaca-table .lbr-input input {
            padding-right: 25px;
        }

        .kaca-table .lbr-input::after {
            content: "";
            position: absolute;
            right: 70px;
            top: 49%;
            transform: translateY(-50%);
            color: #666;
            font-size: 12px;
            font-weight: 500;
            pointer-events: none;
        }

        .kaca-table .total-lbr-input {
            position: relative;
        }

        .kaca-table .total-lbr-input input {
            padding-right: 25px;
        }

        .kaca-table .total-lbr-input::after {
            content: "";
            position: absolute;
            right: 95px;
            top: 49%;
            transform: translateY(-50%);
            color: #666;
            font-size: 12px;
            font-weight: 500;
            pointer-events: none;
        }

        /* Total row styles */
        .kaca-table tfoot {
            border-top: 2px solid #dee2e6;
        }

        .kaca-table .total-row {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .kaca-table .total-row:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }



        .kaca-table .grand-total {
            background: #f8f9fa;
            border-radius: 6px;
            margin: 2px;
        }

        .kaca-table .grand-total input {
            background: transparent;
            color: #333;
            font-weight: 600;
            font-size: 14px;
            border: none;
        }

        .kaca-table .grand-total::after {
            color: #666;
            font-weight: 600;
        }

        /* Total inputs styling */
        .kaca-table .total-inputs {
            padding: 8px 12px;
        }

        .kaca-table .total-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .kaca-table .cont-input,
        .kaca-table .seal-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            text-align: left;
            transition: border-color 0.3s ease;
            background: white;
        }

        .kaca-table .cont-input:focus,
        .kaca-table .seal-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .kaca-table .cont-input::placeholder,
        .kaca-table .seal-input::placeholder {
            color: #999;
            font-size: 11px;
        }

        /* PWD column styling */
        .kaca-table .pwd-input {
            width: 60px;
            min-width: 60px;
            max-width: 60px;
        }

        .kaca-table .pwd-input input {
            width: 100%;
            padding: 8px 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            text-align: center;
            text-transform: uppercase;
            transition: border-color 0.3s ease;
            background: white;
        }

        .kaca-table .pwd-input input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .kaca-table .pwd-input input::placeholder {
            color: #999;
            font-size: 10px;
        }

        /* No DO column styling */
        .kaca-table .no-do-input {
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .kaca-table .no-do-input input {
            width: 100%;
            padding: 8px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            text-align: left;
            transition: border-color 0.3s ease;
            background: white;
        }

        .kaca-table .no-do-input input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .kaca-table .no-do-input input::placeholder {
            color: #999;
            font-size: 10px;
        }

        .kaca-table input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .kaca-table .total-lbr {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .kaca-table .total-lbr input {
            background-color: transparent;
            font-weight: 600;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 4px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-form input, .modal-form textarea {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .modal-form input:focus, .modal-form textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-form textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-save {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-save:hover, .btn-cancel:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .form-container {
                padding: 20px;
                max-width: 100%;
            }

            .main-layout {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
            }

            .left-section, .right-section {
                padding: 20px;
                min-height: auto;
            }

            .right-section {
                display: flex;
                flex-direction: column;
            }

            .log-container {
                flex: 1;
                min-height: 300px;
                max-height: 400px;
            }

            .log-actions {
                margin-top: 20px;
                flex-shrink: 0;
            }

            .form-row {
                flex-direction: column;
                gap: 20px;
            }

            .popup {
                width: 95%;
                padding: 20px;
            }

            .toggle-buttons-btn {
                top: 15px;
                right: 15px;
                padding: 6px 12px;
                font-size: 11px;
            }

            .toggle-buttons-btn.right-section {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                width: 100%;
            }

            .main-actions-container {
                padding: 20px;
                margin-bottom: 20px;
            }

            .main-actions-buttons {
                flex-direction: column;
                gap: 15px;
            }

            /* Print modal responsive */
            .print-modal {
                width: 98%;
                max-width: none;
                margin: 10px;
            }

            .print-textarea-container {
                width: 100%;
                max-width: 794px;
                height: auto;
                min-height: 600px;
            }

            .print-actions {
                flex-direction: column;
                gap: 10px;
            }

            .btn-lock-position, .btn-print-now {
                min-width: 100%;
            }
        }

        @media (max-width: 1200px) {
            .form-container {
                max-width: 95%;
                padding: 25px;
            }
        }

        @media (max-width: 1400px) {
            .form-container {
                max-width: 95%;
            }
        }

        /* Print Modal Styles */
        .print-modal {
            max-width: 1000px;
            width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .print-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
            overflow: hidden;
        }

        .print-textarea-container {
            flex: 1;
            min-height: 300px;
            max-height: 50vh;
            position: relative;
            overflow: auto;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: #fafafa;
            background-image: 
                linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            /* A4 dimensions */
            width: 794px;
            height: 1123px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        /* Custom scrollbar styling */
        .print-textarea-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .print-textarea-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .print-textarea-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }

        .print-textarea-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .print-textarea-container::-webkit-scrollbar-corner {
            background: #f1f1f1;
        }

        .print-textarea-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 794px;
            height: 1123px;
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 5px 5px;
            pointer-events: none;
            z-index: 1;
        }

        .print-text-content {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-width: 300px;
            max-width: 600px;
            white-space: pre-wrap;
            transition: box-shadow 0.2s ease;
        }

        .draggable-text-item {
            position: absolute;
            background: white;
            padding: 4px 8px;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.2;
            cursor: move;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
            z-index: 10;
            max-width: none;
            white-space: nowrap;
            overflow: visible;
            text-overflow: clip;
            min-height: auto;
            height: auto;
            display: inline-flex;
            align-items: flex-start;
            touch-action: none;
            width: fit-content;
        }

        .draggable-text-item.selected {
            border: 2px solid #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            background-color: #f0f4ff;
            z-index: 20;
        }

        /* Ensure selected draggable text is black in print modal */
        #printModalOverlay .draggable-text-item.selected,
        #printModalOverlay .draggable-text-item.selected .text-content {
            color: #000 !important;
        }

        /* Force 8th draggable item (index 7) text to black and neutral background/border */
        #printModalOverlay .print-textarea-container .draggable-text-item[data-index="7"],
        #printModalOverlay .print-textarea-container .draggable-text-item[data-index="7"] .text-content {
            color: #000 !important;
        }
        #printModalOverlay .print-textarea-container .draggable-text-item[data-index="7"] {
            border-color: #e1e5e9 !important;
            background-color: #fff !important;
        }

        /* Ensure kaca-data (index 6) aligns columns top-to-bottom without wrapping */
        #printModalOverlay .print-textarea-container .draggable-text-item[data-index="6"],
        #printModalOverlay .print-textarea-container .draggable-text-item[data-index="6"] .text-content {
            font-family: 'Courier New', monospace !important;
            white-space: pre !important;
        }

        /* Make left column narrower on desktop */
        @media (min-width: 1024px) {
            .left-section { flex: 0 0 42%; max-width: 42%; }
            .right-section { flex: 1 1 58%; max-width: 58%; }
        }

        .draggable-text-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .draggable-text-item.dragging {
            cursor: grabbing;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: none;
            border-color: #667eea;
            background-color: #f8f9ff;
            transform: scale(1.02) rotate(1deg);
        }

        .draggable-text-item:active {
            cursor: grabbing;
            transform: scale(0.98);
        }

        .draggable-text-item::before {
            content: '⋮⋮';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #999;
            pointer-events: none;
            font-weight: bold;
            transition: color 0.2s ease;
        }

        .draggable-text-item:hover::before {
            color: #667eea;
        }

        .draggable-text-item.dragging::before {
            color: #667eea;
            animation: pulse 0.5s ease-in-out infinite alternate;
        }

        .draggable-text-item.locked::before {
            color: #28a745;
        }

        @keyframes pulse {
            from {
                opacity: 0.7;
                transform: translateY(-50%) scale(1);
            }
            to {
                opacity: 1;
                transform: translateY(-50%) scale(1.1);
            }
        }

        .draggable-text-item .text-content {
            margin-left: 16px;
            flex: 1;
            white-space: nowrap;
            overflow: visible;
            min-width: 0;
        }

        /* Override for address element text content */
        .draggable-text-item.address-element .text-content {
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            margin-left: 16px;
            flex: 1;
            overflow: visible;
            min-width: 0;
        }

        /* Ensure print actions are always visible */
        .print-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #dee2e6;
            margin-top: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            max-height: 70vh;
            overflow-y: auto;
            flex-shrink: 0;
        }

        /* Custom scrollbar for print actions */
        .print-actions::-webkit-scrollbar {
            width: 8px;
        }

        .print-actions::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .print-actions::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .print-actions::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Ensure modal content is properly sized */
        .modal.print-modal {
            max-height: 90vh;
            overflow: hidden;
        }

        .modal.print-modal .modal-header {
            flex-shrink: 0;
        }

        .modal.print-modal .print-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal.print-modal .print-textarea-container {
            flex: 1;
            min-height: 300px;
            max-height: 40vh;
        }

        .modal.print-modal .print-actions {
            flex-shrink: 0;
            max-height: 45vh;
        }

        .btn-print-now {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        /* Make save/export/import buttons match print-now style with color variations */
        .btn-save-positions,
        .btn-export-positions,
        .btn-import-positions {
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 130px;
            position: relative;
            overflow: hidden;
        }

        .btn-save-positions {
            background: linear-gradient(135deg, #007bff 0%, #17a2b8 100%);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }
        .btn-save-positions:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
        }

        .btn-export-positions {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }
        .btn-export-positions:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.4);
        }

        .btn-import-positions {
            background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
            color: #212529;
            box-shadow: 0 4px 15px rgba(253, 126, 20, 0.3);
        }
        .btn-import-positions:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(253, 126, 20, 0.4);
        }

        .btn-print-now::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-print-now:hover::before {
            left: 100%;
        }

        .btn-print-now:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-cancel:hover {
            background: linear-gradient(135deg, #5a6268 0%, #343a40 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
        }

        .btn-lock-position {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 130px;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .btn-lock-position:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.4);
        }

        .btn-lock-position.locked {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
        }

        .btn-reset-positions {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: #212529;
            border: 2px solid #ffc107;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            min-width: 130px;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .btn-reset-positions:hover {
            background: linear-gradient(135deg, #fd7e14, #e55a00);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        .draggable-text-item.locked {
            opacity: 0.8;
            border-color: #28a745;
            background-color: #f8fff9 !important;
        }

        .draggable-text-item.locked:hover {
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }

        .draggable-text-item.locked::before {
            color: #28a745;
        }

        .position-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 0, 0.1);
            pointer-events: none;
            z-index: 9999;
        }

        /* Special styling for long text elements */
        .draggable-text-item[data-type="kaca-data"] {
            padding: 4px 8px;
            max-width: 400px;
            width: auto;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            line-height: 1.2;
            height: auto;
            min-height: auto;
            overflow: visible;
        }

        .draggable-text-item[data-type="data"] {
            padding: 4px 8px;
            width: fit-content;
        }

        .draggable-text-item[data-type="total"] {
            padding: 4px 8px;
            width: fit-content;
            font-weight: bold;
        }

        /* Special styling for address element */
        .draggable-text-item[data-index="1"] {
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            max-width: 300px !important;
            width: auto !important;
            height: auto !important;
            min-height: auto !important;
            line-height: 1.3 !important;
            padding: 6px 10px !important;
            overflow: visible !important;
        }

        /* Alternative selector for address element */
        .draggable-text-item.address-element {
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            max-width: 300px !important;
            width: auto !important;
            height: auto !important;
            min-height: auto !important;
            line-height: 1.3 !important;
            padding: 6px 10px !important;
            overflow: visible !important;
        }

        /* Font Controls Styling */
        .font-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .font-controls label {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            min-width: 70px;
        }

        .font-controls select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .font-controls select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .font-controls select:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .print-kaca-data {
            font-size: 8px;
            max-width: 400px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.2;
            overflow: visible;
        }

        /* Column Spacing Controls Styling */
        .column-spacing-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-right: 10px;
        }

        .column-spacing-controls label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            min-width: 80px;
        }

        .column-spacing-controls select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .column-spacing-controls select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .column-spacing-controls select:hover {
            border-color: #667eea;
        }

        /* Individual Column Controls */
        .individual-column-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .column-controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .column-control-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .column-control-item label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            margin: 0;
        }

        .column-control-item input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .column-control-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .column-control-item input:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Quick Preset Buttons */
        .spacing-presets {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            padding-top: 6px;
            border-top: 1px solid #f0f0f0;
        }

        .preset-label {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            margin-right: 4px;
        }

        .preset-btn {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e9ecef;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .preset-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .preset-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.3);
        }

        /* Special styling for kaca-data elements */
        .draggable-text-item[data-type="kaca-data"] {
            padding: 6px 10px !important;
            max-width: none !important;
            width: auto !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            line-height: 1.3 !important;
            height: auto !important;
            min-height: auto !important;
            overflow: visible !important;
            font-family: 'Courier New', monospace !important;
            background-color: #f8f9ff !important;
        }

        .draggable-text-item[data-type="kaca-data"] .text-content {
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            overflow: visible !important;
            min-width: 0 !important;
        }

        /* Position Controls */
        .position-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-lock-position {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 110px;
            box-shadow: 0 3px 10px rgba(111, 66, 193, 0.3);
        }

        .btn-reset-positions {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: #212529;
            border: 2px solid #ffc107;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            min-width: 110px;
            box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);
        }

        /* Action Controls */
        .action-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-print-now {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 130px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
            box-shadow: 0 3px 10px rgba(108, 117, 125, 0.3);
        }

        /* Print Controls Sections */
        .print-controls-section {
            background: white;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        .controls-section-header {
            display: flex;
            align-items: center;
            justify-content: start;
            gap: 5px;
            margin-bottom: 5px;
        }

        .print-controls-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .controls-section-title {
            margin: 0 0 10px 0;
            font-size: 13px;
            font-weight: 700;
            color: #2c3e50;
            padding-bottom: 6px;
            border-bottom: 2px solid #667eea;
            position: relative;
        }

        .controls-section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 25px;
            height: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1px;
        }

        /* Individual Column Controls Styling */
        .individual-column-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .column-controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .column-control-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .column-control-item label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            margin: 0;
        }

        .column-control-item input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .column-control-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .column-control-item input:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Responsive Design for Print Actions */
        @media (max-width: 768px) {
            .print-actions {
                padding: 12px;
                gap: 10px;
                max-height: 60vh;
            }

            .print-controls-section {
                padding: 10px;
            }

            .controls-section-title {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .font-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .font-controls select {
                min-width: 100%;
            }

            .column-controls-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 5px;
            }

            .spacing-presets {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .preset-label {
                margin-bottom: 2px;
            }

            .position-controls,
            .action-controls {
                flex-direction: column;
                gap: 6px;
            }

            .btn-lock-position,
            .btn-reset-positions,
            .btn-print-now,
            .btn-cancel {
                min-width: 100%;
                text-align: center;
                padding: 8px 16px;
            }
        }

        @media (max-width: 480px) {
            .print-actions {
                padding: 8px;
                gap: 8px;
                max-height: 50vh;
            }

            .print-controls-section {
                padding: 8px;
            }

            .column-controls-grid {
                grid-template-columns: 1fr;
                gap: 4px;
            }

            .controls-section-title {
                font-size: 11px;
            }

            .btn-lock-position,
            .btn-reset-positions,
            .btn-print-now,
            .btn-cancel {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* Font Controls Styling */
        .font-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .font-controls label {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            min-width: 70px;
        }

        .font-controls select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        /* Individual Column Controls Styling */
        .individual-column-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .column-controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 6px;
        }

        .column-control-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .column-control-item label {
            font-size: 11px;
            font-weight: 600;
            color: #555;
            margin: 0;
        }

        .column-control-item input {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 11px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        /* Smooth transitions for column spacing updates */
        .print-textarea-container {
            transition: all 0.3s ease;
        }

        .controls-section-title {
            transition: color 0.3s ease;
        }

        /* Visual feedback for column spacing changes */
        .column-control-item input {
            transition: all 0.3s ease;
        }

        .column-control-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }

        /* Loading indicator for column spacing updates */
        .column-spacing-loading {
            position: relative;
        }

        .column-spacing-loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            pointer-events: none;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.3; }
            50% { opacity: 0.6; }
            100% { opacity: 0.3; }
        }

        /* Special styling for kaca-data elements with TOTAL LBR column */
        .draggable-text-item[data-type="kaca-data"] {
            padding: 6px 10px !important;
            max-width: none !important;
            width: auto !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            line-height: 1.3 !important;
            height: auto !important;
            min-height: auto !important;
            overflow: visible !important;
            font-family: 'Courier New', monospace !important;
            background-color: #f8f9ff !important;
            border: 1px solid #e1e5e9 !important;
        }

        .draggable-text-item[data-type="kaca-data"] .text-content {
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            overflow: visible !important;
            min-width: 0 !important;
            font-size: inherit !important;
        }

        /* Highlight TOTAL LBR column in kaca-data */
        .draggable-text-item[data-type="kaca-data"] .text-content {
            position: relative;
        }

        /* Add visual separator for columns in kaca-data */
        .draggable-text-item[data-type="kaca-data"] .text-content::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                transparent calc(100% - 80px), 
                rgba(102, 126, 234, 0.1) calc(100% - 80px), 
                rgba(102, 126, 234, 0.1) 100%);
            pointer-events: none;
            z-index: -1;
        }

        /* Log System Styles */
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .log-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        .btn-clear-log {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-clear-log:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        .log-container {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 0px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .log-search-input {
            height: 40px;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            min-width: 220px;
            font-size: 14px;
            outline: none;
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .log-search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .no-log-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .no-log-message p {
            margin: 5px 0;
        }

        .log-hint {
            font-size: 12px;
            font-style: italic;
            color: #999;
        }

        /* FAB to toggle log action buttons */
        .right-section { position: relative; }
        .log-header-actions { gap: 10px; align-items: center; }
        .log-action-buttons { display: none; gap: 10px; align-items: center; }
        .right-section.log-fab-open .log-action-buttons { display: flex; }
        .log-fab {
            position: absolute;
            right: 5px;
            bottom: 5px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            color: white;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            z-index: 10;
        }
        .log-fab:hover { 
            transform: translateY(-2px);
            box-shadow: 0 14px 28px rgba(0,0,0,0.18);
        }
        .right-section.log-fab-open .log-fab { background: linear-gradient(135deg, #17a2b8 0%, #0d6efd 100%); }
        .log-fab .icon-plus { transition: transform 0.2s ease; display: inline-block; }
        .right-section.log-fab-open .log-fab .icon-plus { transform: rotate(45deg); }

        .log-entry {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 3px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .log-entry:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .log-entry:active {
            transform: translateY(0);
        }

        .log-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .log-timestamp {
            font-size: 11px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .log-toggle-icon {
            font-size: 16px;
            color: #667eea;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .log-content-default {
            display: block;
        }

        .log-content-detailed {
            display: none;
        }

        /* Make detailed log items show as "Label : Value" on one line */
        .log-content-detailed .log-item {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            gap: 6px;
        }
        .log-content-detailed .log-label {
            min-width: 130px; /* keep colon aligned vertically */
            font-size: 1em;
            font-weight: 600; /* bold label */
        }
        .log-content-detailed .log-sep {
            display: inline-block;
            width: 12px;
            text-align: center;
        }
        .log-content-detailed .log-value {
            font-size: 1em;
            font-weight: 400;
            white-space: pre-wrap;
        }

        .log-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 13px;
        }

        .log-item {
            display: flex;
            flex-direction: column;
        }

        .log-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .log-value {
            color: #555;
            word-break: break-word;
        }

        .log-actions-detailed {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }

        .btn-load-data {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-load-data:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        /* removed .btn-save-log styles */

        .btn-export-log {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn-export-log:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.3);
        }

        .btn-import-log {
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn-import-log:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 110, 253, 0.3);
        }

        /* New buttons for log actions */
        .btn-edit-log {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 110px;
        }
        .btn-edit-log:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(111, 66, 193, 0.3);
        }
        .btn-delete-log {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 110px;
        }
        .btn-delete-log:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        /* Responsive design for log system */
        @media (max-width: 768px) {
            .log-content {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .log-actions {
                flex-direction: column;
            }
            
            .btn-export-log, .btn-edit-log, .btn-delete-log {
                min-width: 100%;
            }
        }

        .log-content-default {
            display: block;
        }

        .log-content-detailed {
            display: none;
        }

        /* Compact line styling */
        .log-compact-line {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            line-height: 1.4;
            padding: 8px 0;
        }

        .log-compact-item {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .log-compact-label {
            font-size: 14px;
            color: #667eea;
            flex-shrink: 0;
        }

        .log-compact-value {
            color: #333;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .log-compact-separator {
            color: #ccc;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
            margin: 0 4px;
        }

        /* Responsive for compact view */
        @media (max-width: 768px) {
            .log-compact-line {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .log-compact-separator {
                display: none;
            }
            
            .log-compact-item {
                width: 100%;
            }
            
            .log-compact-value {
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SURAT JALAN</h1>
        </div>
        
        <div class="form-container">
            <div class="main-layout">
                <!-- Sebelah Kiri - Form Input Data Toko -->
                <div class="left-section" style="
						   height: 300px;
   						   margin-bottom: 5px;">
                    
                    <form id="tokoForm">
                        <div class="form-row">
                            <!-- Kolom Kiri -->
                            <div class="form-column">
                                <div class="form-group">
                                    <div class="autocomplete-container">
                                        <div class="input-with-icon">
                                            <input 
                                                type="text" 
                                                id="namaToko" 
                                                name="namaToko" 
                                                placeholder="Nama Toko"
                                                required
                                                autocomplete="off"
                                            >
                                            <button type="button" class="input-icon" onclick="showQuickAddModal()" title="Tambah Toko Baru">
                                                ➕
                                            </button>
                                        </div>
                                        <div class="autocomplete-dropdown" id="autocompleteDropdown">
                                            <!-- Autocomplete items will be generated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <textarea 
                                        id="alamat" 
                                        name="alamat" 
                                        placeholder="Alamat akan muncul otomatis setelah mengisi nama toko"
                                        readonly
                                        class="auto-resize"
                                    ></textarea>
                                </div>

                                <div class="form-group">
                                    <input 
                                        type="text" 
                                        id="alias" 
                                        name="alias" 
                                        placeholder="Alias"
                                        autocomplete="off"
                                    >
                                </div>
                            </div>
                            
                            <!-- Kolom Kanan -->
                            <div class="form-column">
                                <div class="form-group">
                                    <input 
                                        type="date" 
                                        id="tanggal" 
                                        name="tanggal" 
                                        placeholder="Tanggal"
                                        required
                                    >
                                </div>
                                
                                <div class="form-group" id="nomorSJGroup">
                                    <input 
                                        type="text" 
                                        id="nomorSJ" 
                                        name="nomorSJ" 
                                        placeholder="No. SJ"
                                        required
                                        aria-describedby="nomorSJWarning"
                                    >
                                    <div id="nomorSJWarning" class="field-warning" style="display:none;" role="alert" aria-live="polite">
                                        ⚠️ No. SJ sama dengan input sebelumnya
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <input 
                                        type="text" 
                                        id="supir" 
                                        name="supir" 
                                        placeholder="Nama Supir"
                                        required
                                    >
                                </div>
                                
                                <div class="form-group">
                                    <input 
                                        type="text" 
                                        id="noKendaraan" 
                                        name="noKendaraan" 
                                        placeholder="No. Kendaraan"
                                        required
                                    >
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Sebelah Kanan - Log Input History -->
                <div class="right-section" style="
    						  margin-bottom: 5px;">
                    <div class="log-header" role="button" tabindex="0" aria-expanded="false" aria-controls="inputLogContainer">
                        <h3>📝 Log Input History</h3>
                        <div class="log-header-actions" role="group" aria-label="Log actions" style="display: flex; gap: 10px; align-items: stretch; opacity: 0.9; flex-flow: column wrap-reverse; place-content: flex-end center;">
                            <input type="text" id="logSearchInput" class="log-search-input" placeholder="Search" oninput="applyLogSearch()" title="Ketik untuk mencari di log">
                            <div class="log-action-buttons">
                                <button type="button" class="btn-export-log" onclick="exportInputLogToCSV()" title="Export ke CSV (Excel)">⬇️ Export Log</button>
                                <button type="button" class="btn-import-log" onclick="document.getElementById('importLogFileInput').click()" title="Import dari CSV (Excel)">⬆️ Import Log</button>
                                <input type="file" id="importLogFileInput" accept=".csv" style="display:none" onchange="handleImportLogFile(event)">
                                <button type="button" class="btn-clear-log" onclick="clearInputLog()" title="Hapus semua log">🗑️ Clear Log</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="log-container" id="inputLogContainer" style="display:none;">
                        <!-- Log entries will be generated here -->
                        <div class="no-log-message">
                            <p>Belum ada log input</p>
                            <p class="log-hint">Log akan tersimpan otomatis saat Anda menekan Print Sekarang</p>
                        </div>
                    </div>
                    <div class="log-actions" style="display:none; gap:0px; margin-top:0px;"></div>
                    <button type="button" class="log-fab" onclick="event.stopPropagation(); toggleLogFab(this)" title="Tampilkan/sembunyikan tombol log"><span class="icon-plus">＋</span></button>
                    
                    
                </div>
            </div>
            

            
            <!-- Container Data Kaca -->
            <div class="kaca-data-container">
                <div class="kaca-header">
                    <button type="button" class="btn-refresh-page" onclick="refreshPage()">🔄 Refresh Halaman</button>
                    <div class="kaca-controls">
                            <button type="button" class="btn-print-now" onclick="handleQuickPrint()">🖨️ Print Sekarang</button>
                            <button type="button" class="btn-print" onclick="showPrintModal()">🖨️ Print Setting</button>
                        <button type="button" class="btn-add-row" onclick="addKacaRow()">➕ Tambah Baris</button>
                        <button type="button" class="btn-remove-row" onclick="removeKacaRow()">➖ Hapus Baris</button>
                    </div>
                </div>
                
                <div class="kaca-table-container">
                    <table class="kaca-table" id="kacaTable">
                        <thead>
                            <tr>
                                <th>JENIS KACA</th>
                                <th>PWD</th>
                                <th>NO DO</th>
                                <th>UKURAN</th>
                                <th>BOX</th>
                                <th>LBR</th>
                                <th>TOTAL LBR</th>
                            </tr>
                        </thead>
                        <tbody id="kacaTableBody">
                            <!-- Baris default akan di-generate oleh JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td class="total-inputs">
                                    <div class="total-input-group">
                                        <input type="text" placeholder="CONT" class="cont-input">
                                        <input type="text" placeholder="SEAL" class="seal-input">
                                    </div>
                                </td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td class="total-lbr total-lbr-input grand-total">
                                    <input type="text" placeholder="0 LBR" class="grand-total-input" readonly>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                    <!-- Datalists for auto-fill suggestions -->
                    <datalist id="datalistJenisKaca"></datalist>
                    <datalist id="datalistUkuran"></datalist>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup Daftar Toko -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title">📋 Daftar Toko dan Alamat</h3>
                <button class="close-btn" onclick="hideTokoList()">&times;</button>
            </div>
            <div class="toko-list" id="tokoList">
                <!-- Daftar toko akan di-generate oleh JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal Tambah/Edit Toko -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="mainModal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">➕ Tambah Toko Baru</h3>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <form class="modal-form" id="modalForm">
                <input type="hidden" id="editIndex" value="">
                <div>
                    <input 
                        type="text" 
                        id="modalNamaToko" 
                        placeholder="Nama Toko"
                        required style="border-right-width: 2px;height: 47px;width: 450px;"
                    >
                </div>
                <div>
                    <textarea 
                        id="modalAlamat" 
                        placeholder="Alamat Toko (gunakan Enter untuk baris baru)"
                        required style="width: 453px;"
                    ></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="hideModal()">Batal</button>
                    <button type="submit" class="btn-save" id="saveBtn">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div class="modal-overlay" id="quickAddModalOverlay">
        <div class="modal quick-add">
            <div class="modal-header">
                <h3 class="modal-title">➕ Tambah Toko Cepat</h3>
                <button class="modal-close" onclick="hideQuickAddModal()">&times;</button>
            </div>
            
            <!-- Quick Actions Tabs -->
            <div class="quick-tabs">
                <button type="button" class="tab-btn active" onclick="showQuickAddTab()">➕ Tambah Baru</button>
                <button type="button" class="tab-btn" onclick="showQuickListTab()">📋 Lihat Daftar</button>
            </div>
            
            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Tab 1: Form Tambah Toko -->
                <div class="tab-pane active" id="quickAddTab">
                    <form class="modal-form" id="quickAddForm">
                        <div>
                            <input 
                                type="text" 
                                id="quickAddNamaToko" 
                                placeholder="Nama Toko"
                                required
                            >
                        </div>
                        <div>
                            <textarea 
                                id="quickAddAlamat" 
                                placeholder="Alamat Toko (gunakan Enter untuk baris baru)"
                                required
                            ></textarea>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn-cancel" onclick="hideQuickAddModal()">Batal</button>
                            <button type="submit" class="btn-save">Simpan</button>
                        </div>
                    </form>
                </div>
                
                <!-- Tab 2: Daftar Toko -->
                <div class="tab-pane" id="quickListTab">
                    <div class="quick-list-container">
                        <div class="quick-list-header">
                            <h4>📋 Daftar Toko Tersedia</h4>
                            <p>Klik pada toko untuk mengisi form otomatis</p>
                        </div>
                        <div class="quick-toko-list" id="quickTokoList">
                            <!-- Daftar toko akan di-generate di sini -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Modal -->
    <div class="modal-overlay" id="printModalOverlay">
        <div class="modal print-modal">
            <div class="modal-header">
                <h3 class="modal-title">🖨️ Print Data</h3>
                <button class="modal-close" onclick="hidePrintModal()">&times;</button>
            </div>
            
            <div class="print-content">
                <div class="print-textarea-container">
                    <!-- Draggable text elements will be generated here -->
                </div>
                
                <div class="print-actions">
                    <!-- Font Controls Section -->
                    <div class="print-controls-section">
                        <h4 class="controls-section-title">📝 Pengaturan Font</h4>
                        <div class="font-controls">
                            <label for="fontSizeControl">Ukuran Font:</label>
                            <select id="fontSizeControl" onchange="changeFontSize()">
                                <option value="8">8px - Sangat Kecil</option>
                                <option value="10" selected>10px - Kecil</option>
                                <option value="12">12px - Sedang</option>
                                <option value="14">14px - Besar</option>
                                <option value="16">16px - Sangat Besar</option>
                                <option value="18">18px - Ekstra Besar</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Column Spacing Section -->
                    <div class="print-controls-section">
                        <div class="controls-section-header">
                            <h4 class="controls-section-title">📊 Pengaturan Kolom</h4>
                            <button type="button" class="btn-print-now" onclick="printNow()">🖨️ Print Sekarang</button>
                            <button type="button" class="btn-save-positions" onclick="saveCurrentPositions()" title="Simpan posisi teks">💾 Simpan Posisi</button>
                            <button type="button" class="btn-export-positions" onclick="exportPositionsToJSON()" title="Export posisi ke file JSON">⬇️ Export Posisi</button>
                            <button type="button" class="btn-import-positions" onclick="document.getElementById('importPositionsFileInput').click()" title="Import posisi dari file JSON">⬆️ Import Posisi</button>
                            <input type="file" id="importPositionsFileInput" accept=".json" style="display:none" onchange="handleImportPositionsFile(event)">
                        </div>
                        <div class="individual-column-controls">
                            <div class="column-controls-grid">
                                <div class="column-control-item">
                                    <label>Jenis Kaca:</label>
                                    <input type="number" id="colJenisKaca" value="15" min="8" max="30">
                                </div>
                                <div class="column-control-item">
                                    <label>PWD:</label>
                                    <input type="number" id="colPwd" value="8" min="5" max="15">
                                </div>
                                <div class="column-control-item">
                                    <label>NO DO:</label>
                                    <input type="number" id="colNoDo" value="12" min="8" max="20">
                                </div>
                                <div class="column-control-item">
                                    <label>Ukuran:</label>
                                    <input type="number" id="colUkuran" value="12" min="8" max="20">
                                </div>
                                <div class="column-control-item">
                                    <label>BOX:</label>
                                    <input type="number" id="colBox" value="10" min="6" max="15">
                                </div>
                                <div class="column-control-item">
                                    <label>LBR:</label>
                                    <input type="number" id="colLbr" value="10" min="6" max="15">
                                </div>
                                <div class="column-control-item">
                                    <label>Total LBR:</label>
                                    <input type="number" id="colTotalLbr" value="12" min="8" max="20">
                                </div>
                            </div>
                            
                            <div class="spacing-presets">
                                <span class="preset-label">Preset Cepat:</span>
                                <button type="button" class="preset-btn" onclick="applyPreset('compact')">Compact</button>
                                <button type="button" class="preset-btn active" onclick="applyPreset('normal')">Normal</button>
                                <button type="button" class="preset-btn" onclick="applyPreset('wide')">Wide</button>
                                <button type="button" class="preset-btn" onclick="applyPreset('custom')">Custom</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Position Controls Section removed per request -->
                    
                    
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>

    <script>
        // Quick print from header (uses current print settings, opens modal silently to generate data, then prints)
        function handleQuickPrint() {
            // Open modal to ensure latest data/layout prepared (hidden quickly)
            const modal = document.getElementById('printModalOverlay');
            const prevDisplay = modal.style.display;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            try {
                loadFontSizePreference();
                loadColumnSpacingFromStorage();
                refreshPrintData();
                // Small delay to allow DOM updates
                setTimeout(() => {
                    // Auto-save log before printing
                    try { saveCurrentInputToLog(); } catch (e) { console.warn('Auto-save log failed:', e); }
                    printNow();
                    // Close modal after triggering print
                    hidePrintModal();
                }, 50);
            } catch (e) {
                console.error('Quick print error:', e);
                // Fallback: show modal so user can print manually
                modal.style.display = 'flex';
            } finally {
                // Restore body overflow when modal hides via hidePrintModal
            }
        }
        // Utilitas database toko bersama untuk autocomplete dan auto-fill
        function buildTokoMapFromArray(arrayOfToko) {
            const nameToAddress = {};
            if (Array.isArray(arrayOfToko)) {
                arrayOfToko.forEach(entry => {
                    if (entry && entry.nama) {
                        nameToAddress[entry.nama.toLowerCase()] = entry.alamat || '';
                    }
                });
            }
            return nameToAddress;
        }

        function getDatabaseToko() {
            let map = {};
            try {
                const saved = JSON.parse(localStorage.getItem('databaseToko') || 'null');
                if (saved && typeof saved === 'object') {
                    map = saved;
                }
            } catch (_) {}
            if (typeof databaseTokoLengkap !== 'undefined') {
                const defaults = buildTokoMapFromArray(databaseTokoLengkap);
                // Prioritaskan data tersimpan; gabungkan default untuk melengkapi
                map = Object.assign(defaults, map);
            }
            return map;
        }

        function persistDatabaseTokoFromLengkap() {
            if (typeof databaseTokoLengkap === 'undefined') return;
            const map = buildTokoMapFromArray(databaseTokoLengkap);
            try { localStorage.setItem('databaseToko', JSON.stringify(map)); } catch (_) {}
        }

        // Fungsi untuk mengisi alamat otomatis berdasarkan nama toko
        document.getElementById('namaToko').addEventListener('input', function() {
            const rawInput = this.value || '';
            const namaTokoLower = rawInput.toLowerCase();
            const alamatField = document.getElementById('alamat');
            const autocompleteDropdown = document.getElementById('autocompleteDropdown');
            
            // Tampilkan autocomplete jika ada input (case-insensitive, cari di nama/alamat)
            if (namaTokoLower.length > 0) {
                showAutocomplete(namaTokoLower);
            } else {
                hideAutocomplete();
            }
            
            // Auto-fill alamat jika ada yang cocok
            const match = Array.isArray(databaseTokoLengkap)
                ? databaseTokoLengkap.find(t => (t.nama || '').toLowerCase() === namaTokoLower)
                : null;
            if (match) {
                // Samakan casing nama pada input sesuai data tersimpan
                try { this.value = match.nama || this.value; } catch (_) {}
                alamatField.value = (match.alamat || '');
                alamatField.style.backgroundColor = '#f8f9fa';
                autoResizeTextarea(alamatField);
            } else {
                alamatField.value = '';
                alamatField.style.backgroundColor = '#fff';
                alamatField.style.height = '80px';
            }
        });

        // Fungsi untuk format tanggal Indonesia
        document.getElementById('tanggal').addEventListener('change', function() {
            const date = new Date(this.value);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            // Format tanggal Indonesia
            const tanggalIndonesia = date.toLocaleDateString('id-ID', options);
            console.log('Tanggal yang dipilih:', tanggalIndonesia);
        });

        // Handle form submission
        document.getElementById('tokoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const namaToko = document.getElementById('namaToko').value;
            const alamat = document.getElementById('alamat').value;
            const tanggal = document.getElementById('tanggal').value;
            const nomorSJ = document.getElementById('nomorSJ').value;
            const supir = document.getElementById('supir').value;
            const noKendaraan = document.getElementById('noKendaraan').value;
            
            if (!namaToko || !tanggal || !nomorSJ || !supir || !noKendaraan) {
                alert('Mohon lengkapi semua field yang wajib diisi!');
                return;
            }
            
            // Format tanggal untuk output
            const date = new Date(tanggal);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const tanggalFormatted = date.toLocaleDateString('id-ID', options);
            
            // Output data
            const output = `
Data yang diinput:
Nama Toko: ${namaToko}
Alamat: ${alamat || 'Tidak ada alamat'}
Tanggal: ${tanggalFormatted}
No. SJ: ${nomorSJ}
Nama Supir: ${supir}
No. Kendaraan: ${noKendaraan}
            `;
            
            alert(output);
            console.log(output);
        });

        // Set tanggal default ke hari ini
        document.getElementById('tanggal').valueAsDate = new Date();

        // Database toko yang lebih lengkap
        const databaseTokoLengkap = [
            {
                nama: 'Toko Sejahtera',
                alamat: 'Jl. Raya Utama No. 123\nKecamatan Central\nKota Metropolitan, Provinsi Jawa Barat\nKode Pos: 12345'
            },
            {
                nama: 'Toko Makmur',
                alamat: 'Jl. Pasar Baru No. 45\nKecamatan Business District\nKota Metropolitan, Provinsi Jawa Barat\nKode Pos: 12346'
            },
            {
                nama: 'Toko Sukses',
                alamat: 'Jl. Industri No. 67\nKecamatan Industrial Area\nKota Metropolitan, Provinsi Jawa Barat\nKode Pos: 12347'
            },
            {
                nama: 'Toko Jaya',
                alamat: 'Jl. Komersial No. 89\nKecamatan Commercial Zone\nKota Metropolitan, Provinsi Jawa Barat\nKode Pos: 12348'
            },
            {
                nama: 'Toko Berkah',
                alamat: 'Jl. Harmoni No. 12\nKecamatan Harmony\nKota Metropolitan, Provinsi Jawa Barat\nKode Pos: 12349'
            },
            {
                nama: 'Toko Indah',
                alamat: 'Jl. Cendana No. 34\nKecamatan Beautiful\nKota Metropolitan, Provinsi Jawa Barat\nKode Pos: 12350'
            },
            {
                nama: 'Toko Maju',
                alamat: 'Jl. Progresif No. 56\nKecamatan Progressive\nKota Metropolitan, Provinsi Jawa Barat\nKode Pos: 12351'
            },
            {
                nama: 'Toko Sentosa',
                alamat: 'Jl. Damai No. 78\nKecamatan Peaceful\nKota Metropolitan, Provinsi Jawa Barat\nKode Pos: 12352'
            }
        ];
        // Load dari localStorage bila ada data tersimpan untuk daftar lengkap
        (function loadDatabaseTokoLengkapFromStorage(){
            try {
                const saved = JSON.parse(localStorage.getItem('databaseTokoLengkap') || 'null');
                if (Array.isArray(saved) && saved.length > 0) {
                    databaseTokoLengkap.splice(0, databaseTokoLengkap.length, ...saved);
                }
            } catch (_) {}
        })();

        function persistDatabaseTokoLengkapArray() {
            try { localStorage.setItem('databaseTokoLengkap', JSON.stringify(databaseTokoLengkap)); } catch (_) {}
        }
        // Inisialisasi database autocomplete tersimpan pada load pertama
        if (!localStorage.getItem('databaseToko')) {
            persistDatabaseTokoFromLengkap();
        }

        // Fungsi untuk menampilkan popup daftar toko
        function showTokoList() {
            const popup = document.getElementById('popupOverlay');
            const tokoList = document.getElementById('tokoList');
            
            // Generate daftar toko
            tokoList.innerHTML = '';
            databaseTokoLengkap.forEach((toko, index) => {
                const tokoItem = document.createElement('div');
                tokoItem.className = 'toko-item';
                tokoItem.innerHTML = `
                    <div class="toko-nama">🏪 ${toko.nama}</div>
                    <div class="toko-alamat">📍 ${toko.alamat}</div>
                    <div class="action-buttons">
                        <button class="btn-edit" onclick="editToko(${index})">✏️ Edit</button>
                        <button class="btn-delete" onclick="deleteToko(${index})">🗑️ Hapus</button>
                    </div>
                `;
                tokoList.appendChild(tokoItem);
            });
            
            popup.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        // Fungsi untuk menyembunyikan popup
        function hideTokoList() {
            const popup = document.getElementById('popupOverlay');
            popup.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        // Close popup when clicking outside
        document.getElementById('popupOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                hideTokoList();
            }
        });

        // Close popup with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideTokoList();
                hideModal();
                hideQuickAddModal();
                hidePrintModal();
            }
        });

        // Refresh page helper
        function refreshPage() {
            try {
                window.location.reload();
            } catch (_) {
                // Fallback: navigate to same URL
                window.location.href = window.location.href;
            }
        }

        // Fungsi untuk menampilkan modal tambah toko
        function showAddModal() {
            const modal = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const saveBtn = document.getElementById('saveBtn');
            const editIndex = document.getElementById('editIndex');
            
            modalTitle.textContent = '➕ Tambah Toko Baru';
            saveBtn.textContent = 'Simpan';
            editIndex.value = '';
            
            // Reset form
            document.getElementById('modalNamaToko').value = '';
            document.getElementById('modalAlamat').value = '';
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Fungsi untuk menampilkan quick add modal
        function showQuickAddModal() {
            const modal = document.getElementById('quickAddModalOverlay');
            
            // Reset form
            document.getElementById('quickAddNamaToko').value = '';
            document.getElementById('quickAddAlamat').value = '';
            
            // Reset ke tab pertama
            showQuickAddTab();
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Fungsi untuk menampilkan tab tambah toko
        function showQuickAddTab() {
            const addTab = document.getElementById('quickAddTab');
            const listTab = document.getElementById('quickListTab');
            if (addTab) addTab.classList.add('active');
            if (listTab) listTab.classList.remove('active');
            // Update tab buttons safely tanpa bergantung pada event
            const buttons = Array.from(document.querySelectorAll('.tab-btn'));
            buttons.forEach(btn => btn.classList.remove('active'));
            const addBtn = buttons.find(b => /Tambah Baru/i.test(b.textContent || ''));
            if (addBtn) addBtn.classList.add('active');
        }

        // Fungsi untuk menampilkan tab daftar toko
        function showQuickListTab() {
            const addTab = document.getElementById('quickAddTab');
            const listTab = document.getElementById('quickListTab');
            if (addTab) addTab.classList.remove('active');
            if (listTab) listTab.classList.add('active');
            // Update tab buttons safely tanpa bergantung pada event
            const buttons = Array.from(document.querySelectorAll('.tab-btn'));
            buttons.forEach(btn => btn.classList.remove('active'));
            const listBtn = buttons.find(b => /Lihat Daftar/i.test(b.textContent || ''));
            if (listBtn) listBtn.classList.add('active');
            // Generate daftar toko
            generateQuickTokoList();
        }

        // Fungsi untuk menyembunyikan quick add modal
        function hideQuickAddModal() {
            const modal = document.getElementById('quickAddModalOverlay');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Fungsi untuk menampilkan modal edit toko
        function editToko(index) {
            const modal = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const saveBtn = document.getElementById('saveBtn');
            const editIndex = document.getElementById('editIndex');
            const toko = databaseTokoLengkap[index];
            
            modalTitle.textContent = '✏️ Edit Toko';
            saveBtn.textContent = 'Update';
            editIndex.value = index;
            
            // Isi form dengan data yang ada
            document.getElementById('modalNamaToko').value = toko.nama;
            document.getElementById('modalAlamat').value = toko.alamat;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Fungsi untuk menghapus toko
        function deleteToko(index) {
            if (confirm('Apakah Anda yakin ingin menghapus toko ini?')) {
                databaseTokoLengkap.splice(index, 1);
                // Sinkronkan database autocomplete dan daftar lengkap yang tersimpan
                persistDatabaseTokoFromLengkap();
                persistDatabaseTokoLengkapArray();
                
                // Refresh popup jika sedang terbuka
                if (document.getElementById('popupOverlay').style.display === 'flex') {
                    showTokoList();
                }
                // Refresh quick list tab jika sedang terbuka
                const quickModal = document.getElementById('quickAddModalOverlay');
                const quickListTab = document.getElementById('quickListTab');
                if (quickModal && quickModal.style.display === 'flex' && quickListTab && quickListTab.classList.contains('active')) {
                    generateQuickTokoList();
                }

                alert('Toko berhasil dihapus!');
            }
        }

        // Fungsi untuk menyembunyikan modal
        function hideModal() {
            const modal = document.getElementById('modalOverlay');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Handle form modal submission
        document.getElementById('modalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const namaToko = document.getElementById('modalNamaToko').value.trim();
            const alamat = document.getElementById('modalAlamat').value.trim();
            const editIndex = document.getElementById('editIndex').value;
            
            if (!namaToko || !alamat) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            if (editIndex === '') {
                // Tambah toko baru
                const newToko = {
                    nama: namaToko,
                    alamat: alamat
                };
                
                databaseTokoLengkap.push(newToko);
                // Sinkronkan database autocomplete dan daftar lengkap yang tersimpan
                persistDatabaseTokoFromLengkap();
                persistDatabaseTokoLengkapArray();
                
                alert('Toko berhasil ditambahkan!');
            } else {
                // Edit toko yang ada
                const index = parseInt(editIndex);
                const oldNama = databaseTokoLengkap[index].nama;
                
                // Update database lengkap
                databaseTokoLengkap[index] = {
                    nama: namaToko,
                    alamat: alamat
                };
                // Sinkronkan database autocomplete dan daftar lengkap yang tersimpan
                persistDatabaseTokoFromLengkap();
                persistDatabaseTokoLengkapArray();
                
                alert('Toko berhasil diupdate!');
            }
            
            hideModal();
            
            // Refresh popup jika sedang terbuka
            if (document.getElementById('popupOverlay').style.display === 'flex') {
                showTokoList();
            }

            // Refresh quick list tab jika sedang terbuka
            const quickModal = document.getElementById('quickAddModalOverlay');
            const quickListTab = document.getElementById('quickListTab');
            if (quickModal && quickModal.style.display === 'flex' && quickListTab && quickListTab.classList.contains('active')) {
                generateQuickTokoList();
            }
        });

        // Close modal when clicking outside
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal();
            }
        });

        // Close quick add modal when clicking outside
        document.getElementById('quickAddModalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                hideQuickAddModal();
            }
        });

        // Handle quick add form submission
        document.getElementById('quickAddForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Normalisasi: simpan Nama apa adanya (preserve case) untuk tampilan,
            // namun lakukan pencarian/duplikasi dengan lower-case key
            const namaInput = document.getElementById('quickAddNamaToko').value.trim();
            const alamatInput = document.getElementById('quickAddAlamat').value.trim();
            const namaKey = namaInput.toLowerCase();
            
            if (!namaInput || !alamatInput) {
                alert('Mohon lengkapi semua field yang wajib diisi!');
                return;
            }
            
            // Tambah toko baru
            const newToko = {
                nama: namaInput,
                alamat: alamatInput
            };
            
            // Cek duplikasi berdasarkan lower-case key
            const existingIndex = databaseTokoLengkap.findIndex(t => (t.nama || '').toLowerCase() === namaKey);
            if (existingIndex >= 0) {
                // Update yang lama untuk menjaga satu sumber truth
                databaseTokoLengkap[existingIndex] = newToko;
            } else {
                databaseTokoLengkap.push(newToko);
            }
            // Sinkronkan database autocomplete dan daftar lengkap yang tersimpan
            persistDatabaseTokoFromLengkap();
            persistDatabaseTokoLengkapArray();
            // Segarkan daftar cepat bila tab "Lihat Daftar" dibuka setelahnya
            try { generateQuickTokoList(); } catch (_) {}
            
            // Auto-fill form utama
            const alamatField = document.getElementById('alamat');
            document.getElementById('namaToko').value = namaInput;
            alamatField.value = alamatInput;
            alamatField.style.backgroundColor = '#f8f9fa';
            
            // Auto-resize textarea
            autoResizeTextarea(alamatField);
            
            alert('Toko berhasil ditambahkan dan form telah diisi otomatis!');
            hideQuickAddModal();
        });

        // Fungsi untuk auto-resize textarea
        function autoResizeTextarea(textarea) {
            // Reset height untuk mendapatkan scrollHeight yang akurat
            textarea.style.height = 'auto';
            
            // Set height berdasarkan konten
            const newHeight = Math.max(80, textarea.scrollHeight);
            textarea.style.height = newHeight + 'px';
        }

        // Fungsi untuk generate baris default tabel kaca
        // Removed generateDefaultKacaRows (not used anymore)

        // Fungsi untuk menambah baris baru
        function addKacaRow() {
            try {
                const tbody = document.getElementById('kacaTableBody');
                if (!tbody) {
                    console.error('kacaTableBody element not found');
                    return;
                }
                
                const newRow = document.createElement('tr');
                const rowId = Date.now() + Math.random();
                
                newRow.innerHTML = `
                    <td>
                        <input type="text" placeholder="Jenis Kaca" class="jenis-kaca" list="datalistJenisKaca" onchange="calculateTotalLbr(this)" autocomplete="off" autocapitalize="none" spellcheck="false">
                    </td>
                    <td class="pwd-input">
                        <input type="text" placeholder="PWD" class="pwd" maxlength="3">
                    </td>
                    <td class="no-do-input">
                        <input type="text" placeholder="No DO" class="no-do">
                    </td>
                    <td>
                        <input type="text" placeholder="Ukuran" class="ukuran" list="datalistUkuran" onchange="calculateTotalLbr(this)" autocomplete="off" autocapitalize="none" spellcheck="false">
                    </td>
                    <td class="box-input">
                        <input type="text" placeholder="0 BOX" class="box" onchange="calculateTotalLbr(this)" oninput="calculateTotalLbr(this)">
                    </td>
                    <td class="lbr-input">
                        <input type="text" placeholder="0 LBR" class="lbr" onchange="calculateTotalLbr(this)" oninput="calculateTotalLbr(this)">
                    </td>
                    <td class="total-lbr total-lbr-input">
                        <input type="text" placeholder="0 LBR" class="total-lbr-input" readonly>
                    </td>
                `;
                
                tbody.appendChild(newRow);

                // Attach simple inline drop-down behavior to encourage reuse
                const jenisInput = newRow.querySelector('input.jenis-kaca');
                const ukuranInput = newRow.querySelector('input.ukuran');
                if (jenisInput) {
                    jenisInput.setAttribute('autocomplete', 'off');
                    jenisInput.setAttribute('autocapitalize', 'none');
                    jenisInput.setAttribute('spellcheck', 'false');
                    jenisInput.addEventListener('focus', updateKacaSuggestionsFromLogs, { once: true });
                }
                if (ukuranInput) {
                    ukuranInput.setAttribute('autocomplete', 'off');
                    ukuranInput.setAttribute('autocapitalize', 'none');
                    ukuranInput.setAttribute('spellcheck', 'false');
                    ukuranInput.addEventListener('focus', updateKacaSuggestionsFromLogs, { once: true });
                }
                
                // Update grand total setelah tambah baris
                setTimeout(() => {
                    updateGrandTotal();
                }, 100);
                
                // Trigger print data refresh if modal is open
                const printModal = document.getElementById('printModalOverlay');
                if (printModal && printModal.style.display === 'flex') {
                    setTimeout(() => {
                        if (typeof refreshPrintData === 'function') {
                            refreshPrintData();
                        }
                    }, 100);
                }
                
                console.log('Glass row added successfully');
            } catch (error) {
                console.error('Error adding glass row:', error);
            }
        }

        // Fungsi untuk menghapus baris
        function removeKacaRow() {
            try {
                const tbody = document.getElementById('kacaTableBody');
                if (!tbody) {
                    console.error('kacaTableBody element not found');
                    return;
                }
                
                const rows = tbody.querySelectorAll('tr');
                
                if (rows.length > 1) {
                    tbody.removeChild(rows[rows.length - 1]);
                    // Update grand total setelah hapus baris
                    setTimeout(() => {
                        updateGrandTotal();
                    }, 100);
                    
                    // Trigger print data refresh if modal is open
                    const printModal = document.getElementById('printModalOverlay');
                    if (printModal && printModal.style.display === 'flex') {
                        setTimeout(() => {
                            if (typeof refreshPrintData === 'function') {
                                refreshPrintData();
                            }
                        }, 100);
                    }
                } else {
                    alert('Minimal harus ada 1 baris!');
                }
            } catch (error) {
                console.error('Error removing glass row:', error);
            }
        }

        // Fungsi untuk menghitung total LBR
        function calculateTotalLbr(input) {
            try {
                if (!input) {
                    console.error('Input parameter is null or undefined');
                    return;
                }
                
                const row = input.closest('tr');
                if (!row) {
                    console.error('Row element not found');
                    return;
                }
                
                const boxInput = row.querySelector('input.box');
                const lbrInput = row.querySelector('input.lbr');
                const totalInput = row.querySelector('input.total-lbr-input');
                
                if (!boxInput || !lbrInput || !totalInput) {
                    console.error('Input elements not found:', { boxInput, lbrInput, totalInput });
                    return;
                }
                
                // Extract angka dari input BOX (misal: "2 BOX" -> 2)
                const boxValue = boxInput.value || '';
                const boxMatch = boxValue.trim().match(/^(\d+(?:\.\d+)?)/);
                const box = boxMatch ? parseFloat(boxMatch[1]) : 0;
                
                // Extract angka dari input LBR (misal: "100 LBR" -> 100)
                const lbrValue = lbrInput.value || '';
                const lbrMatch = lbrValue.trim().match(/^(\d+(?:\.\d+)?)/);
                const lbr = lbrMatch ? parseFloat(lbrMatch[1]) : 0;
                
                const total = box * lbr;
                
                // Format total dengan satuan LBR
                totalInput.value = Math.round(total) + " LBR";
                
                // Update grand total
                setTimeout(() => {
                    updateGrandTotal();
                }, 100);
                
                // Trigger print data refresh if modal is open
                const printModal = document.getElementById('printModalOverlay');
                if (printModal && printModal.style.display === 'flex') {
                    setTimeout(() => {
                        if (typeof refreshPrintData === 'function') {
                            refreshPrintData();
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('Error calculating total LBR:', error);
            }
        }

        // Fungsi untuk menghitung total keseluruhan
        function calculateGrandTotal() {
            const totalInputs = document.querySelectorAll('.total-lbr-input:not(.grand-total-input)');
            let grandTotal = 0;
            
            totalInputs.forEach(input => {
                // Extract angka dari format "100 LBR"
                const value = input.value;
                if (value && typeof value === 'string') {
                    const trimmedValue = value.trim();
                    const match = trimmedValue.match(/^(\d+(?:\.\d+)?)/);
                    const number = match ? parseFloat(match[1]) : 0;
                    grandTotal += number;
                }
            });
            
            return grandTotal;
        }

        // Fungsi untuk update grand total
        function updateGrandTotal() {
            try {
                const grandTotal = calculateGrandTotal();
                const grandTotalInput = document.querySelector('.grand-total-input');
                
                if (grandTotalInput) {
                    grandTotalInput.value = grandTotal + " LBR";
                } else {
                    console.warn('Grand total input element not found');
                }
                
                // Trigger print data refresh if modal is open
                const printModal = document.getElementById('printModalOverlay');
                if (printModal && printModal.style.display === 'flex') {
                    setTimeout(() => {
                        if (typeof refreshPrintData === 'function') {
                            refreshPrintData();
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('Error updating grand total:', error);
            }
        }

        // Event listener untuk input changes
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('box') || e.target.classList.contains('lbr')) {
                calculateTotalLbr(e.target);
            }
        });

        // Event listener untuk blur (ketika input kehilangan focus)
        document.addEventListener('blur', function(e) {
            if (e.target.classList.contains('box')) {
                autoAddBoxUnit(e.target);
            } else if (e.target.classList.contains('lbr')) {
                autoAddLbrUnit(e.target);
            }
        }, true);

        // Event listener untuk keydown (ENTER key)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const target = e.target;
                
                // Auto-add unit jika user menekan ENTER pada input BOX atau LBR
                if (target.classList.contains('box')) {
                    autoAddBoxUnit(target);
                } else if (target.classList.contains('lbr')) {
                    autoAddLbrUnit(target);
                }
                
                // Navigasi form dengan ENTER
                if (target.id === 'namaToko') {
                    e.preventDefault();
                    document.getElementById('tanggal').focus();
                } else if (target.id === 'tanggal') {
                    e.preventDefault();
                    document.getElementById('nomorSJ').focus();
                } else if (target.id === 'nomorSJ') {
                    e.preventDefault();
                    document.getElementById('supir').focus();
                } else if (target.id === 'supir') {
                    e.preventDefault();
                    document.getElementById('noKendaraan').focus();
                } else if (target.id === 'noKendaraan') {
                    e.preventDefault();
                    // Focus ke input Jenis Kaca di baris pertama
                    const firstJenisKacaInput = document.querySelector('input.jenis-kaca');
                    if (firstJenisKacaInput) {
                        firstJenisKacaInput.focus();
                        firstJenisKacaInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                
                // Cek apakah input berada di tabel kaca
                if (target.closest('#kacaTable')) {
                    const currentRow = target.closest('tr');
                    const tbody = document.getElementById('kacaTableBody');
                    const rows = tbody.querySelectorAll('tr');
                    const isLastRow = currentRow === rows[rows.length - 1];
                    
                    // Navigasi antar kolom dalam tabel
                    if (target.classList.contains('jenis-kaca')) {
                        e.preventDefault();
                        const nextInput = currentRow.querySelector('input.pwd');
                        if (nextInput) nextInput.focus();
                    } else if (target.classList.contains('pwd')) {
                        e.preventDefault();
                        const nextInput = currentRow.querySelector('input.no-do');
                        if (nextInput) nextInput.focus();
                    } else if (target.classList.contains('no-do')) {
                        e.preventDefault();
                        const nextInput = currentRow.querySelector('input.ukuran');
                        if (nextInput) nextInput.focus();
                    } else if (target.classList.contains('ukuran')) {
                        e.preventDefault();
                        const nextInput = currentRow.querySelector('input.box');
                        if (nextInput) nextInput.focus();
                    } else if (target.classList.contains('box')) {
                        e.preventDefault();
                        const nextInput = currentRow.querySelector('input.lbr');
                        if (nextInput) nextInput.focus();
                    } else if (target.classList.contains('lbr')) {
                        // Jika ini adalah baris terakhir dan semua field terisi
                        if (isLastRow && isRowComplete(currentRow)) {
                            e.preventDefault();
                            
                            // Visual feedback - highlight baris saat ini
                            currentRow.style.backgroundColor = '#e8f5e8';
                            setTimeout(() => {
                                currentRow.style.backgroundColor = '';
                            }, 300);
                            
                            addKacaRow();
                            
                            // Focus ke input Jenis Kaca di baris baru
                            setTimeout(() => {
                                const allRows = tbody.querySelectorAll('tr');
                                const newRow = allRows[allRows.length - 1]; // Ambil baris terakhir (yang baru)
                                const jenisKacaInput = newRow.querySelector('input.jenis-kaca');
                                
                                if (jenisKacaInput) {
                                    jenisKacaInput.focus();
                                    
                                    // Tambahan: scroll ke input jika perlu
                                    jenisKacaInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                } else {
                                    // Fallback: coba focus ke input pertama
                                    const firstInput = newRow.querySelector('input');
                                    if (firstInput) {
                                        firstInput.focus();
                                    }
                                }
                            }, 200);
                        } else {
                            // Jika bukan baris terakhir, pindah ke baris berikutnya
                            e.preventDefault();
                            const nextRow = currentRow.nextElementSibling;
                            if (nextRow) {
                                const nextJenisKacaInput = nextRow.querySelector('input.jenis-kaca');
                                if (nextJenisKacaInput) {
                                    nextJenisKacaInput.focus();
                                    nextJenisKacaInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }
                        }
                    }
                }
            }
        });

        // Fungsi untuk mengecek apakah baris sudah terisi lengkap
        function isRowComplete(row) {
            const inputs = row.querySelectorAll('input:not([readonly])');
            let filledCount = 0;
            let totalInputs = 0;
            
            inputs.forEach(input => {
                totalInputs++;
                const value = input.value;
                if (value && typeof value === 'string' && value.trim() !== '') {
                    filledCount++;
                }
            });
            
            // Minimal 3 field harus terisi (jenis kaca, box, lbr)
            // Atau jika user menekan ENTER pada field terakhir yang terisi
            const currentInput = document.activeElement;
            const isLastInput = currentInput === row.querySelector('input:last-of-type');
            
            return filledCount >= 3 || (filledCount >= 2 && isLastInput);
        }

        // Fungsi untuk otomatis menambahkan satuan BOX
        function autoAddBoxUnit(input) {
            const value = input.value.trim();
            if (value && !value.toLowerCase().includes('box')) {
                // Cek apakah input hanya berisi angka
                const numberMatch = value.match(/^(\d+(?:\.\d+)?)$/);
                if (numberMatch) {
                    input.value = value + ' BOX';
                    // Trigger calculation after adding unit
                    calculateTotalLbr(input);
                }
            }
        }

        // Fungsi untuk otomatis menambahkan satuan LBR
        function autoAddLbrUnit(input) {
            const value = input.value.trim();
            if (value && !value.toLowerCase().includes('lbr')) {
                // Cek apakah input hanya berisi angka
                const numberMatch = value.match(/^(\d+(?:\.\d+)?)$/);
                if (numberMatch) {
                    input.value = value + ' LBR';
                    // Trigger calculation after adding unit
                    calculateTotalLbr(input);
                }
            }
        }

        // Fungsi untuk generate daftar toko di quick modal
        function generateQuickTokoList() {
            const quickTokoList = document.getElementById('quickTokoList');
            
            if (databaseTokoLengkap.length === 0) {
                quickTokoList.innerHTML = '<div class="no-results">Belum ada toko yang tersedia</div>';
                return;
            }
            
            let html = '';
            databaseTokoLengkap.forEach((toko, index) => {
                html += `
                    <div class="quick-toko-item" onclick="selectQuickToko('${toko.nama}', '${toko.alamat.replace(/\n/g, '\\n')}')">
                        <div class="quick-toko-name">🏪 ${toko.nama}</div>
                        <div class="quick-toko-address">📍 ${toko.alamat}</div>
                        <div class="quick-toko-actions">
                            <button type="button" class="btn-edit" onclick="event.stopPropagation(); editToko(${index})">✏️ Edit</button>
                            <button type="button" class="btn-delete" onclick="event.stopPropagation(); deleteToko(${index})">🗑️ Hapus</button>
                        </div>
                    </div>
                `;
            });
            
            quickTokoList.innerHTML = html;
        }

        // Fungsi untuk memilih toko dari quick list
        function selectQuickToko(namaToko, alamat) {
            const alamatField = document.getElementById('alamat');
            // Isi form utama
            document.getElementById('namaToko').value = namaToko;
            alamatField.value = alamat.replace(/\\n/g, '\n');
            alamatField.style.backgroundColor = '#f8f9fa';
            
            // Auto-resize textarea
            autoResizeTextarea(alamatField);
            
            // Tutup modal
            hideQuickAddModal();
            
            // Tampilkan feedback
            alert(`Form telah diisi dengan data ${namaToko}!`);
        }

        function getDisplayNameForKey(lowerKey) {
            try {
                const entry = Array.isArray(databaseTokoLengkap)
                    ? databaseTokoLengkap.find(t => (t.nama || '').toLowerCase() === String(lowerKey || ''))
                    : null;
                if (entry && entry.nama) return entry.nama;
            } catch (_) {}
            // Fallback: Title Case dari lowerKey
            return String(lowerKey || '').replace(/\b\w+/g, s => s.charAt(0).toUpperCase() + s.slice(1));
        }

        // Fungsi untuk menampilkan autocomplete
        function showAutocomplete(searchTerm) {
            const dropdown = document.getElementById('autocompleteDropdown');
            const matches = [];
            const map = getDatabaseToko();
            // Cari toko yang cocok berdasarkan nama ATAU alamat (case-insensitive)
            Object.keys(map).forEach(key => {
                const nameLower = key;
                const addressLower = String(map[key] || '').toLowerCase();
                if (nameLower.includes(searchTerm) || addressLower.includes(searchTerm)) {
                    matches.push({
                        namaKey: key,
                        displayName: getDisplayNameForKey(key),
                        alamat: map[key]
                    });
                }
            });
            
            // Generate HTML untuk dropdown
            if (matches.length > 0) {
                let html = '';
                matches.forEach((toko, index) => {
                    html += `
                        <div class="autocomplete-item" data-index="${index}" onclick="selectToko('${toko.displayName.replace(/'/g, "&#39;")}', '${toko.alamat.replace(/\n/g, '\\n').replace(/'/g, "&#39;")}')">
                            <div class="autocomplete-item-icon">🏪</div>
                            <div class="autocomplete-item-text">
                                <div class="autocomplete-item-name">${toko.displayName}</div>
                                <div class="autocomplete-item-address">${toko.alamat.split('\n')[0]}...</div>
                            </div>
                        </div>
                    `;
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } else {
                dropdown.innerHTML = '<div class="no-results">Tidak ada toko yang cocok</div>';
                dropdown.style.display = 'block';
            }
        }

        // Fungsi untuk menyembunyikan autocomplete
        function hideAutocomplete() {
            const dropdown = document.getElementById('autocompleteDropdown');
            dropdown.style.display = 'none';
        }

        // Fungsi untuk memilih toko dari autocomplete
        function selectToko(namaToko, alamat) {
            const alamatField = document.getElementById('alamat');
            document.getElementById('namaToko').value = namaToko;
            alamatField.value = alamat.replace(/\\n/g, '\n');
            alamatField.style.backgroundColor = '#f8f9fa';
            // Auto-resize textarea
            autoResizeTextarea(alamatField);
            hideAutocomplete();
        }

        // Sembunyikan autocomplete saat klik di luar
        document.addEventListener('click', function(e) {
            const autocompleteContainer = document.querySelector('.autocomplete-container');
            if (!autocompleteContainer.contains(e.target)) {
                hideAutocomplete();
            }
        });

        // Keyboard navigation untuk autocomplete
        document.getElementById('namaToko').addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('autocompleteDropdown');
            const items = dropdown.querySelectorAll('.autocomplete-item');
            const selectedItem = dropdown.querySelector('.autocomplete-item.selected');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (selectedItem) {
                    selectedItem.classList.remove('selected');
                    const nextItem = selectedItem.nextElementSibling;
                    if (nextItem && nextItem.classList.contains('autocomplete-item')) {
                        nextItem.classList.add('selected');
                    } else {
                        items[0]?.classList.add('selected');
                    }
                } else {
                    items[0]?.classList.add('selected');
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (selectedItem) {
                    selectedItem.classList.remove('selected');
                    const prevItem = selectedItem.previousElementSibling;
                    if (prevItem && prevItem.classList.contains('autocomplete-item')) {
                        prevItem.classList.add('selected');
                    } else {
                        items[items.length - 1]?.classList.add('selected');
                    }
                } else {
                    items[items.length - 1]?.classList.add('selected');
                }
            } else if (e.key === 'Enter' && selectedItem) {
                e.preventDefault();
                selectedItem.click();
            } else if (e.key === 'Escape') {
                hideAutocomplete();
            }
        });

        // Fungsi untuk toggle hide/unhide tombol
        function toggleButtons() {
            const mainActionsContainer = document.getElementById('mainActionsContainer');
            const toggleBtn = document.querySelector('.toggle-buttons-btn');
            const isHidden = mainActionsContainer.classList.contains('hidden');
            
            if (isHidden) {
                // Tampilkan tombol
                mainActionsContainer.classList.remove('hidden');
                toggleBtn.innerHTML = '🔽 Sembunyikan Tombol';
                toggleBtn.style.background = 'linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%)';
            } else {
                // Sembunyikan tombol
                mainActionsContainer.classList.add('hidden');
                toggleBtn.innerHTML = '🔼 Tampilkan Tombol';
                toggleBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            }
        }

        // Set state awal - tombol tersembunyi
        window.addEventListener('load', function() {
            try {
                // Tombol tersembunyi secara default
                const mainActionsContainer = document.getElementById('mainActionsContainer');
                const toggleBtn = document.querySelector('.toggle-buttons-btn');
                
                if (mainActionsContainer && toggleBtn) {
                    mainActionsContainer.classList.add('hidden');
                    toggleBtn.innerHTML = '🔼 Tampilkan Tombol';
                    toggleBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                }
                
                // Tambahkan 1 baris default jika belum ada
                setTimeout(() => {
                    const tbody = document.getElementById('kacaTableBody');
                    if (tbody && tbody.children.length === 0) {
                        addKacaRow();
                    }
                }, 200);
                
                // Test fungsi kalkulasi
                setTimeout(() => {
                    console.log('Testing calculateTotalLbr function...');
                    const testInput = document.querySelector('.box');
                    if (testInput) {
                        console.log('Test input found, function should work');
                    } else {
                        console.error('Test input not found');
                    }
                }, 1500);
                
                console.log('Page initialization completed successfully');
            } catch (error) {
                console.error('Error during page initialization:', error);
            }
        });

        // Backup initialization untuk memastikan glass data ter-load
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Cek apakah glass data sudah ada, jika belum, tambahkan 1 baris default
                setTimeout(() => {
                    const kacaTableBody = document.getElementById('kacaTableBody');
                    if (kacaTableBody && kacaTableBody.children.length === 0) {
                        console.log('Glass data not found, adding one default row...');
                        addKacaRow();
                    }
                }, 500);
            } catch (error) {
                console.error('Error during DOMContentLoaded:', error);
            }
        });

        // Debug function untuk testing glass data
        // Removed debugGlassData (not used anymore)

        // Print Modal Functions
        function adjustLayoutForSinglePage() {
            const container = document.querySelector('.print-textarea-container');
            const textElements = container.querySelectorAll('.draggable-text-item');
            
            if (textElements.length === 0) return;
            
            // A4 dimensions in pixels (matching container dimensions)
            const a4Width = 794;
            const a4Height = 1123;
            const margin = 40; // 20px margin on each side
            
            // Calculate available space
            const maxWidth = a4Width - (margin * 2);
            const maxHeight = a4Height - (margin * 2);
            
            // Check if elements need adjustment (only if they're outside bounds or too close together)
            let needsAdjustment = false;
            let previousY = -1;
            
            textElements.forEach((element, index) => {
                const currentX = parseInt(element.style.left) || 20;
                const currentY = parseInt(element.style.top) || 20;
                
                // Check if element is outside A4 bounds
                if (currentX < margin || currentX > maxWidth || currentY < margin || currentY > maxHeight) {
                    needsAdjustment = true;
                }
                
                // Check if elements are too close together (less than 30px spacing)
                if (previousY !== -1 && Math.abs(currentY - previousY) < 30) {
                    needsAdjustment = true;
                }
                
                previousY = currentY;
            });
            
            // Only adjust if really necessary
            if (needsAdjustment) {
                console.log('Layout adjustment needed - repositioning elements');
                
                // Adjust positions to fit on single A4 page with better spacing
                textElements.forEach((element, index) => {
                    const currentX = parseInt(element.style.left) || 20;
                    
                    // Ensure X position is within A4 bounds
                    let newX = Math.max(margin, Math.min(currentX, maxWidth));
                    
                    // Use better spacing - minimum 60px between elements
                    const minSpacing = 60;
                    const newY = margin + (index * minSpacing);
                    
                    // Ensure Y position doesn't exceed A4 height
                    const finalY = Math.min(newY, maxHeight);
                    
                    // Apply new positions
                    element.style.left = newX + 'px';
                    element.style.top = finalY + 'px';
                });
                
                // Scroll to top to show the arranged layout
                container.scrollTop = 0;
            } else {
                console.log('No layout adjustment needed - keeping current positions');
            }
        }

        // Add event listeners for real-time column spacing updates
        function addColumnSpacingEventListeners() {
            const columnInputs = [
                'colJenisKaca', 'colPwd', 'colNoDo', 'colUkuran', 'colBox', 'colLbr', 'colTotalLbr'
            ];
            
            columnInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // Remove existing listeners to prevent duplicates
                    input.removeEventListener('input', updateColumnSpacing);
                    input.removeEventListener('change', updateColumnSpacing);
                    
                    // Add new listeners for real-time updates
                    input.addEventListener('input', debounce(updateColumnSpacing, 300));
                    input.addEventListener('change', updateColumnSpacing);
                }
            });
        }

        // Debounce function to prevent too many updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Update the showPrintModal function to add event listeners
        function showPrintModal() {
            const modal = document.getElementById('printModalOverlay');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Load font size preference
            loadFontSizePreference();
            
            // Load column spacing preference
            loadColumnSpacingFromStorage();
            
            // Generate print data
            refreshPrintData();
            
            // Add event listeners for column spacing
            setTimeout(() => {
                addColumnSpacingEventListeners();
            }, 100);
            
            // Smart position handling based on user preferences
            if (!positionsLocked) {
                if (Object.keys(savedPositions).length === 0) {
                    // First time - apply default layout
                    setTimeout(() => {
                        adjustLayoutForSinglePage();
                        initDragAndDropForElements();
                    }, 100);
                } else {
                    // User has saved positions - preserve them with minimal adjustment
                    setTimeout(() => {
                        preserveUserPositions();
                        initDragAndDropForElements();
                    }, 100);
                }
            } else {
                // Positions are locked - no adjustments
                setTimeout(() => {
                    initDragAndDropForElements();
                }, 100);
            }
            
            // Restore lock button state
            const lockBtn = document.querySelector('.btn-lock-position');
            if (lockBtn) {
                if (positionsLocked) {
                    lockBtn.textContent = '🔓 Unlock Posisi';
                    lockBtn.classList.add('locked');
                } else {
                    lockBtn.textContent = '🔒 Lock Posisi';
                    lockBtn.classList.remove('locked');
                }
            }
        }

        function hidePrintModal() {
            const modal = document.getElementById('printModalOverlay');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function refreshPrintData() {
            // Use the clean version that doesn't include headers
            refreshPrintDataClean();
        }

        function validateAndAdjustForSinglePage() {
            const container = document.querySelector('.print-textarea-container');
            const textElements = container.querySelectorAll('.draggable-text-item');
            
            if (textElements.length === 0) return;
            
            // A4 dimensions in pixels (matching container dimensions)
            const a4Width = 794;
            const a4Height = 1123;
            const margin = 40;
            
            let needsAdjustment = false;
            let previousY = -1;
            
            // Check if any element is beyond A4 boundaries or too close together
            textElements.forEach(element => {
                const x = parseInt(element.style.left) || 0;
                const y = parseInt(element.style.top) || 0;
                
                // Check if element is outside A4 bounds
                if (x < margin || x > (a4Width - margin) || y < margin || y > (a4Height - margin)) {
                    needsAdjustment = true;
                }
                
                // Check if elements are too close together (less than 40px spacing)
                if (previousY !== -1 && Math.abs(y - previousY) < 40) {
                    needsAdjustment = true;
                }
                
                previousY = y;
            });
            
            // If adjustment is needed, apply single page layout
            if (needsAdjustment) {
                console.log('Validation detected layout issues - applying adjustments');
                adjustLayoutForSinglePage();
            } else {
                console.log('Validation passed - no adjustments needed');
            }
        }

        function debugPositions() {
            const container = document.querySelector('.print-textarea-container');
            const textElements = container.querySelectorAll('.draggable-text-item');
            
            console.log('=== Position Debug ===');
            console.log('Container dimensions:', {
                width: container.offsetWidth,
                height: container.offsetHeight,
                scrollLeft: container.scrollLeft,
                scrollTop: container.scrollTop
            });
            
            textElements.forEach((element, index) => {
                const x = parseInt(element.style.left) || 0;
                const y = parseInt(element.style.top) || 0;
                const text = element.querySelector('.text-content')?.textContent || '';
                
                console.log(`Element ${index}:`, {
                    text: text.substring(0, 30) + '...',
                    x: x,
                    y: y,
                    computedLeft: element.style.left,
                    computedTop: element.style.top
                });
            });
        }

        function showPositionOverlay() {
            const container = document.querySelector('.print-textarea-container');
            const textElements = container.querySelectorAll('.draggable-text-item');
            
            // Remove existing overlay
            const existingOverlay = document.querySelector('.position-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'position-overlay';
            overlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 0, 0.1);
                pointer-events: none;
                z-index: 9999;
            `;
            
            textElements.forEach((element, index) => {
                const x = parseInt(element.style.left) || 0;
                const y = parseInt(element.style.top) || 0;
                
                const marker = document.createElement('div');
                marker.style.cssText = `
                    position: absolute;
                    left: ${x}px;
                    top: ${y}px;
                    width: 10px;
                    height: 10px;
                    background: red;
                    border-radius: 50%;
                    z-index: 10000;
                `;
                marker.title = `Element ${index}: x=${x}, y=${y}`;
                overlay.appendChild(marker);
            });
            
            container.appendChild(overlay);
            
            // Remove overlay after 3 seconds
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.remove();
                }
            }, 3000);
        }

        function printNow() {
            const container = document.querySelector('.print-textarea-container');
            const textElements = container.querySelectorAll('.draggable-text-item');
            
            if (textElements.length === 0) {
                alert('Tidak ada konten untuk dicetak!');
                return;
            }
            
            // Show position overlay for debugging
            showPositionOverlay();
            
            // Capture positions BEFORE any adjustments
            let positionedTexts = [];
            textElements.forEach(element => {
                const textContent = element.querySelector('.text-content');
                if (textContent && textContent.textContent.trim()) {
                    // Get exact pixel positions from the drag area
                    const x = parseInt(element.style.left) || 0;
                    const y = parseInt(element.style.top) || 0;
                    const text = textContent.textContent;
                    const type = element.dataset.type || 'data';
                    
                    positionedTexts.push({ x, y, text, type });
                }
            });
            
            // Debug positions before printing
            debugPositions();
            
            // Create a new window for printing with positioned layout
            const printWindow = window.open('', '_blank');
            
            // Sort by Y position first, then X position for consistent layout
            positionedTexts.sort((a, b) => {
                if (a.y !== b.y) return a.y - b.y;
                return a.x - b.x;
            });
            
            // Create HTML with positioned text elements using exact positions
            let positionedHTML = '';
            positionedTexts.forEach((item, index) => {
                // Use exact pixel positions from drag area
                const style = `position: absolute; left: ${item.x}px; top: ${item.y}px;`;
                let className = 'print-text-item';
                
                // Add styling based on type
                if (item.type === 'header') {
                    className += ' print-header';
                } else if (item.type === 'total') {
                    className += ' print-total';
                } else if (item.type === 'kaca-data') {
                    className += ' print-kaca-data';
                } else if (item.type === 'timestamp') {
                    className += ' print-timestamp';
                }
                
                positionedHTML += `<div class="${className}" style="${style}">${item.text}</div>`;
                
                // Debug: Log the exact position being used
                console.log(`Print element ${index}:`, {
                    text: item.text.substring(0, 30) + '...',
                    x: item.x,
                    y: item.y,
                    style: style
                });
            });
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        @page {
                            size: A4 portrait;
                            margin: 0;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Courier New', monospace;
                            font-size: ${currentFontSize}px;
                            line-height: 1.2;
                            position: relative;
                            width: 794px;
                            height: 1123px;
                            overflow: hidden;
                            background: white;
                        }
                        .print-text-item {
                            position: absolute;
                            background: transparent;
                            padding: 4px 8px;
                            border: none;
                            white-space: pre-wrap;
                            max-width: 500px;
                            font-size: ${currentFontSize}px;
                        }
                        .print-header {
                            font-weight: bold;
                        }
                        .print-total {
                            font-weight: bold;
                            color: #000 !important; /* force black for TOTAL */
                            font-size: ${currentFontSize}px;
                        }
                        .print-kaca-data {
                            font-size: ${Math.max(currentFontSize - 2, 8)}px;
                            max-width: 600px;
                        }
                        @media print {
                            @page {
                                size: A4 portrait;
                                margin: 0;
                            }
                            body { 
                                margin: 0; 
                                padding: 0;
                                width: 794px;
                                height: 1123px;
                                overflow: hidden;
                                font-size: ${currentFontSize}px;
                            }
                            .print-text-item {
                                page-break-inside: avoid;
                                page-break-before: avoid;
                                page-break-after: avoid;
                                font-size: ${currentFontSize}px;
                            }
                            * {
                                page-break-inside: avoid;
                                page-break-after: avoid;
                                page-break-before: avoid;
                            }
                            /* Hide browser headers and footers */
                            html, body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            /* Force single page */
                            html {
                                height: 100%;
                                overflow: hidden;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${positionedHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }

        // Close print modal when clicking outside
        document.getElementById('printModalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                hidePrintModal();
            }
        });

        // Drag functionality for print text content
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let currentDraggedElement = null;
        let selectedElement = null;
        let gridEnabled = true;
        let gridSize = 5; // Fine grid by default
        let positionsLocked = false;
        let savedPositions = {};
        let dragStartTime = 0;
        let dragDistance = 0;
        let currentFontSize = 10; // Default font size for print
        let currentColumnSpacing = 12; // Default column spacing for kaca-data
        
        // Individual column spacing configuration
        let columnSpacingConfig = {
            jenisKaca: 15,
            pwd: 8,
            noDo: 12,
            ukuran: 12,
            box: 10,
            lbr: 10,
            totalLbr: 12
        };
        
        // Preset configurations
        const spacingPresets = {
            compact: {
                jenisKaca: 12,
                pwd: 6,
                noDo: 8,
                ukuran: 8,
                box: 6,
                lbr: 6,
                totalLbr: 8
            },
            normal: {
                jenisKaca: 15,
                pwd: 8,
                noDo: 12,
                ukuran: 12,
                box: 10,
                lbr: 10,
                totalLbr: 12
            },
            wide: {
                jenisKaca: 20,
                pwd: 12,
                noDo: 16,
                ukuran: 16,
                box: 14,
                lbr: 14,
                totalLbr: 16
            },
            custom: {
                jenisKaca: 18,
                pwd: 10,
                noDo: 14,
                ukuran: 14,
                box: 12,
                lbr: 12,
                totalLbr: 14
            }
        };
        
        // Load saved positions from localStorage on page load
        function loadSavedPositions() {
            try {
                const saved = localStorage.getItem('printTextPositions');
                if (saved) {
                    savedPositions = JSON.parse(saved);
                    console.log('✅ Loaded saved positions from localStorage:', savedPositions);
                } else {
                    console.log('ℹ️ No saved positions found in localStorage');
                }
            } catch (error) {
                console.error('❌ Error loading saved positions:', error);
                savedPositions = {};
            }
        }
        
        // Save positions to localStorage
        function savePositionsToStorage() {
            try {
                localStorage.setItem('printTextPositions', JSON.stringify(savedPositions));
                console.log('💾 Positions saved to localStorage:', savedPositions);
            } catch (error) {
                console.error('❌ Error saving positions:', error);
            }
        }

        // Save current positions explicitly (triggered by button)
        function saveCurrentPositions() {
            try {
                const container = document.querySelector('.print-textarea-container');
                if (!container) return;
                const textElements = container.querySelectorAll('.draggable-text-item');
                const latest = {};
                textElements.forEach(el => {
                    const index = parseInt(el.dataset.index);
                    const x = Math.round(parseFloat(el.style.left) || 0);
                    const y = Math.round(parseFloat(el.style.top) || 0);
                    if (!isNaN(index)) {
                        latest[index] = { x, y };
                    }
                });
                savedPositions = latest;
                savePositionsToStorage();
                alert('Posisi saat ini telah disimpan.');
            } catch (error) {
                console.error('Error saving current positions:', error);
                alert('Gagal menyimpan posisi: ' + error.message);
            }
        }

        // Export positions to downloadable JSON file
        function exportPositionsToJSON() {
            try {
                const dataStr = JSON.stringify(savedPositions, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const dateStr = new Date().toISOString().replace(/[:.]/g, '-');
                a.href = url;
                a.download = `print-positions-${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting positions:', error);
                alert('Gagal export posisi: ' + error.message);
            }
        }

        // Handle import positions JSON file
        async function handleImportPositionsFile(event) {
            try {
                const file = event.target.files && event.target.files[0];
                if (!file) return;
                const text = await file.text();
                const json = JSON.parse(text);
                if (!json || typeof json !== 'object') throw new Error('Format file tidak valid');
                // Basic validation of structure: values should be {x, y}
                const validated = {};
                Object.keys(json).forEach(key => {
                    const val = json[key];
                    if (val && typeof val.x === 'number' && typeof val.y === 'number') {
                        validated[key] = { x: Math.round(val.x), y: Math.round(val.y) };
                    }
                });
                savedPositions = validated;
                savePositionsToStorage();

                // Apply to DOM immediately if elements exist
                const container = document.querySelector('.print-textarea-container');
                if (container) {
                    const elements = container.querySelectorAll('.draggable-text-item');
                    elements.forEach(el => {
                        const index = parseInt(el.dataset.index);
                        const pos = savedPositions[index];
                        if (pos) {
                            el.style.left = pos.x + 'px';
                            el.style.top = pos.y + 'px';
                        }
                    });
                }
                alert('Posisi berhasil diimport dan diterapkan.');
                // Reset input for re-import
                const input = document.getElementById('importPositionsFileInput');
                if (input) input.value = '';
            } catch (error) {
                console.error('Error importing positions:', error);
                alert('Gagal import posisi: ' + error.message);
            }
        }
        
        // Load positions when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedPositions();
            loadFontSizePreference();
            loadColumnSpacingFromStorage();
        });
        
        // Function to clear saved positions
        function clearSavedPositions() {
            try {
                localStorage.removeItem('printTextPositions');
                savedPositions = {};
                console.log('Saved positions cleared');
                alert('Posisi tersimpan telah dihapus! Posisi akan kembali ke default saat modal dibuka kembali.');
            } catch (error) {
                console.error('Error clearing saved positions:', error);
            }
        }

        function snapToGrid(x, y) {
            if (!gridEnabled) return { x: Math.round(x), y: Math.round(y) };
            
            const snappedX = Math.round(x / gridSize) * gridSize;
            const snappedY = Math.round(y / gridSize) * gridSize;
            
            // Add haptic feedback if supported
            if (navigator.vibrate && Math.abs(x - snappedX) < 2 && Math.abs(y - snappedY) < 2) {
                navigator.vibrate(10);
            }
            
            return { x: Math.round(snappedX), y: Math.round(snappedY) };
        }

        function selectElement(element) {
            // Remove selection from previously selected element
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            
            // Select new element
            selectedElement = element;
            if (element) {
                element.classList.add('selected');
                element.focus();
                
                // Add haptic feedback for selection
                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
                
                // Scroll element into view if needed
                element.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest',
                    inline: 'nearest'
                });
            }
        }

        function moveSelectedElement(direction) {
            if (!selectedElement) return;
            
            const currentX = parseInt(selectedElement.style.left) || 0;
            const currentY = parseInt(selectedElement.style.top) || 0;
            let newX = currentX;
            let newY = currentY;
            
            switch (direction) {
                case 'up':
                    newY = currentY - gridSize;
                    break;
                case 'down':
                    newY = currentY + gridSize;
                    break;
                case 'left':
                    newX = currentX - gridSize;
                    break;
                case 'right':
                    newX = currentX + gridSize;
                    break;
            }
            
            // Constrain to container boundaries with full page range
            const container = selectedElement.closest('.print-textarea-container');
            
            // Use A4 dimensions for boundary calculation
            const containerWidth = 794;  // A4 width in pixels
            const containerHeight = 1123; // A4 height in pixels
            
            const maxX = containerWidth - selectedElement.offsetWidth;
            const maxY = containerHeight - selectedElement.offsetHeight;
            
            // Allow movement across the full page
            newX = Math.max(0, Math.min(newX, maxX));
            newY = Math.max(0, Math.min(newY, maxY));
            
            // Snap to grid
            const snapped = snapToGrid(newX, newY);
            
            selectedElement.style.left = snapped.x + 'px';
            selectedElement.style.top = snapped.y + 'px';
            
            // Save position to localStorage
            const index = parseInt(selectedElement.dataset.index);
            if (!isNaN(index)) {
                savedPositions[index] = { x: Math.round(snapped.x), y: Math.round(snapped.y) };
                savePositionsToStorage();
            }
        }

        function initDragAndDropForElements() {
            const container = document.querySelector('.print-textarea-container');
            
            if (!container) return;
            
            // Remove existing event listeners
            const existingElements = container.querySelectorAll('.draggable-text-item');
            existingElements.forEach(element => {
                element.removeEventListener('mousedown', handleMouseDown);
                element.removeEventListener('click', handleElementClick);
                element.removeEventListener('touchstart', handleTouchStart);
            });
            
            // Add event listeners to all draggable text elements
            const textElements = container.querySelectorAll('.draggable-text-item');
            textElements.forEach(element => {
                element.addEventListener('mousedown', handleMouseDown);
                element.addEventListener('click', handleElementClick);
                element.addEventListener('touchstart', handleTouchStart, { passive: false });
            });
        }

        function handleTouchStart(e) {
            if (positionsLocked) return;
            const touch = e.touches[0];
            const element = e.target && e.target.closest ? e.target.closest('.draggable-text-item') : null;
            if (!element) return;
            
            e.preventDefault();
            
            isDragging = true;
            currentDraggedElement = element;
            dragStartTime = Date.now();
            dragDistance = 0;
            
            currentDraggedElement.classList.add('dragging');
            selectElement(currentDraggedElement);
            
            const rect = currentDraggedElement.getBoundingClientRect();
            const containerRect = currentDraggedElement.closest('.print-textarea-container').getBoundingClientRect();
            
            dragOffsetX = touch.clientX - rect.left;
            dragOffsetY = touch.clientY - rect.top;
            
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleMouseUp);
        }

        function handleElementClick(e) {
            // Select element on click (but not during drag)
            if (!isDragging && !positionsLocked) {
                const el = e.target && e.target.closest ? e.target.closest('.draggable-text-item') : null;
                if (el) selectElement(el);
            }
        }

        function handleMouseDown(e) {
            if (e.button === 0 && !positionsLocked) { // Left mouse button only and not locked
                const el = e.target && e.target.closest ? e.target.closest('.draggable-text-item') : null;
                if (!el) return;
                isDragging = true;
                currentDraggedElement = el;
                dragStartTime = Date.now();
                dragDistance = 0;
                
                // Add dragging class for visual feedback
                currentDraggedElement.classList.add('dragging');
                
                // Select the element being dragged
                selectElement(currentDraggedElement);
                
                const rect = currentDraggedElement.getBoundingClientRect();
                const containerRect = currentDraggedElement.closest('.print-textarea-container').getBoundingClientRect();
                
                // Compute offset relative to element top-left to avoid initial jump
                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;
                
                // Disable transitions during drag to prevent visual jump/glitch
                currentDraggedElement.style.transition = 'none';
                
                // Prevent text selection during drag
                e.preventDefault();
                
                // Add global event listeners
                document.addEventListener('mousemove', handleMouseMove, { passive: false });
                document.addEventListener('mouseup', handleMouseUp);
                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                document.addEventListener('touchend', handleMouseUp);
            }
        }
        
        function handleMouseMove(e) {
            if (!isDragging || !currentDraggedElement) return;
            
            e.preventDefault();
            
            // Use requestAnimationFrame for smooth performance
            requestAnimationFrame(() => {
                const container = currentDraggedElement.closest('.print-textarea-container');
                const containerRect = container.getBoundingClientRect();
                const newX = e.clientX - containerRect.left - dragOffsetX;
                const newY = e.clientY - containerRect.top - dragOffsetY;
                
                // Calculate drag distance for click detection
                const deltaX = e.clientX - (containerRect.left + dragOffsetX);
                const deltaY = e.clientY - (containerRect.top + dragOffsetY);
                dragDistance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                // Constrain to container boundaries
                const maxX = containerRect.width - currentDraggedElement.offsetWidth;
                const maxY = containerRect.height - currentDraggedElement.offsetHeight;
                
                const constrainedX = Math.max(0, Math.min(newX, maxX));
                const constrainedY = Math.max(0, Math.min(newY, maxY));
                
                // Snap to grid
                const snapped = snapToGrid(constrainedX, constrainedY);
                
                // Apply position with smooth transition
                currentDraggedElement.style.transition = 'none';
                currentDraggedElement.style.left = snapped.x + 'px';
                currentDraggedElement.style.top = snapped.y + 'px';
            });
        }
        
        function handleTouchMove(e) {
            if (!isDragging || !currentDraggedElement) return;
            
            e.preventDefault();
            const touch = e.touches[0];
            const container = currentDraggedElement.closest('.print-textarea-container');
            const containerRect = container.getBoundingClientRect();
            
            // Directly compute new position for touch to reduce lag/glitch
            const newX = touch.clientX - containerRect.left - dragOffsetX;
            const newY = touch.clientY - containerRect.top - dragOffsetY;
            
            // Calculate drag distance for click detection
            const deltaX = touch.clientX - (containerRect.left + dragOffsetX);
            const deltaY = touch.clientY - (containerRect.top + dragOffsetY);
            dragDistance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            
            const maxX = containerRect.width - currentDraggedElement.offsetWidth;
            const maxY = containerRect.height - currentDraggedElement.offsetHeight;
            const constrainedX = Math.max(0, Math.min(newX, maxX));
            const constrainedY = Math.max(0, Math.min(newY, maxY));
            const snapped = snapToGrid(constrainedX, constrainedY);
            
            currentDraggedElement.style.left = snapped.x + 'px';
            currentDraggedElement.style.top = snapped.y + 'px';
        }
        
        function handleMouseUp() {
            if (isDragging && currentDraggedElement) {
                const dragDuration = Date.now() - dragStartTime;
                
                // Remove dragging class
                currentDraggedElement.classList.remove('dragging');
                
                // Restore smooth transitions (not position) after drag ends
                currentDraggedElement.style.transition = 'box-shadow 0.2s ease, border-color 0.2s ease, transform 0.15s ease';
                
                // Check if it was a click (short duration and small distance)
                if (dragDuration < 200 && dragDistance < 5) {
                    // It was a click, not a drag
                    selectElement(currentDraggedElement);
                }
                
                            // Save position to localStorage after drag ends
            if (currentDraggedElement) {
                const index = parseInt(currentDraggedElement.dataset.index);
                if (!isNaN(index)) {
                    const x = Math.round(parseFloat(currentDraggedElement.style.left) || 0);
                    const y = Math.round(parseFloat(currentDraggedElement.style.top) || 0);
                    savedPositions[index] = { x, y };
                    savePositionsToStorage();
                }
            }
                
                isDragging = false;
                currentDraggedElement = null;
                
                // Remove global event listeners
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleMouseUp);
            }
        }

        // Keyboard navigation for selected elements
        document.addEventListener('keydown', function(e) {
            if (!selectedElement || positionsLocked) return;
            
            let moved = false;
            
            switch (e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    moveSelectedElement('up');
                    moved = true;
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    moveSelectedElement('down');
                    moved = true;
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    moveSelectedElement('left');
                    moved = true;
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    moveSelectedElement('right');
                    moved = true;
                    break;
            }
            
            // Visual feedback when moving with keyboard
            if (moved) {
                selectedElement.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    selectedElement.style.transform = 'scale(1)';
                }, 150);
            }
        });

        function lockPositions() {
            const container = document.querySelector('.print-textarea-container');
            const textElements = container.querySelectorAll('.draggable-text-item');
            const lockBtn = document.querySelector('.btn-lock-position');
            
            if (!positionsLocked) {
                // Save current positions
                savedPositions = {};
                textElements.forEach((element, index) => {
                    const x = Math.round(parseFloat(element.style.left) || 0);
                    const y = Math.round(parseFloat(element.style.top) || 0);
                    savedPositions[index] = { x, y };
                });
                
                // Save to localStorage for persistence
                savePositionsToStorage();
                
                // Lock positions
                positionsLocked = true;
                lockBtn.textContent = '🔓 Unlock Posisi';
                lockBtn.classList.add('locked');
                
                // Disable dragging
                textElements.forEach(element => {
                    element.style.cursor = 'not-allowed';
                    element.classList.add('locked');
                });
                
                alert('Posisi teks telah dikunci dan tersimpan! Posisi akan tetap ada meskipun halaman di-refresh.');
            } else {
                // Unlock positions
                positionsLocked = false;
                lockBtn.textContent = '🔒 Lock Posisi';
                lockBtn.classList.remove('locked');
                
                // Enable dragging
                textElements.forEach(element => {
                    element.style.cursor = 'move';
                    element.classList.remove('locked');
                });
                
                alert('Posisi teks telah dibuka kunci! Anda dapat mengatur ulang posisi.');
            }
        }

        // Function to preserve user positions more effectively
        function preserveUserPositions() {
            const container = document.querySelector('.print-textarea-container');
            const textElements = container.querySelectorAll('.draggable-text-item');
            
            if (textElements.length === 0) return;
            
            // Save current positions before any adjustments
            const currentPositions = {};
            textElements.forEach((element, index) => {
                const x = parseInt(element.style.left) || 0;
                const y = parseInt(element.style.top) || 0;
                currentPositions[index] = { x, y };
            });
            
            // Only adjust if positions are significantly problematic
            let needsAdjustment = false;
            const a4Width = 794;
            const a4Height = 1123;
            const margin = 40;
            
            Object.values(currentPositions).forEach(pos => {
                if (pos.x < margin || pos.x > (a4Width - margin) || pos.y < margin || pos.y > (a4Height - margin)) {
                    needsAdjustment = true;
                }
            });
            
            if (needsAdjustment) {
                console.log('Critical position issues detected - minimal adjustment needed');
                // Apply minimal adjustments only for out-of-bounds elements
                textElements.forEach((element, index) => {
                    const pos = currentPositions[index];
                    let newX = pos.x;
                    let newY = pos.y;
                    
                    // Only adjust if out of bounds
                    if (pos.x < margin) newX = margin;
                    if (pos.x > (a4Width - margin)) newX = a4Width - margin;
                    if (pos.y < margin) newY = margin;
                    if (pos.y > (a4Height - margin)) newY = a4Height - margin;
                    
                    // Apply only if changed
                    if (newX !== pos.x || newY !== pos.y) {
                        element.style.left = newX + 'px';
                        element.style.top = newY + 'px';
                    }
                });
            } else {
                console.log('User positions preserved - no adjustments needed');
            }
        }

        // Function to change font size of print elements
        function changeFontSize() {
            const fontSizeSelect = document.getElementById('fontSizeControl');
            const newFontSize = parseInt(fontSizeSelect.value);
            currentFontSize = newFontSize;
            
            // Update font size of all draggable text elements
            const textElements = document.querySelectorAll('.draggable-text-item');
            textElements.forEach(element => {
                element.style.fontSize = newFontSize + 'px';
            });
            
            console.log(`📝 Font size changed to ${newFontSize}px`);
            
            // Save font size preference to localStorage
            try {
                localStorage.setItem('printFontSize', newFontSize.toString());
                console.log('💾 Font size preference saved to localStorage');
            } catch (error) {
                console.error('❌ Error saving font size preference:', error);
            }
        }

        // Function to load saved font size preference
        function loadFontSizePreference() {
            try {
                const savedFontSize = localStorage.getItem('printFontSize');
                if (savedFontSize) {
                    const fontSize = parseInt(savedFontSize);
                    currentFontSize = fontSize;
                    
                    // Update select element
                    const fontSizeSelect = document.getElementById('fontSizeControl');
                    if (fontSizeSelect) {
                        fontSizeSelect.value = fontSize;
                    }
                    
                    console.log(`📝 Loaded saved font size: ${fontSize}px`);
                }
            } catch (error) {
                console.error('❌ Error loading font size preference:', error);
            }
        }

        // Function to change column spacing of kaca-data
        function changeColumnSpacing() {
            const spacingSelect = document.getElementById('columnSpacingControl');
            const newSpacing = parseInt(spacingSelect.value);
            currentColumnSpacing = newSpacing;
            
            // Update column spacing of kaca-data elements
            const kacaDataElements = document.querySelectorAll('.draggable-text-item[data-type="kaca-data"]');
            kacaDataElements.forEach(element => {
                // Reformat the text content with new column spacing
                const textContent = element.querySelector('.text-content');
                if (textContent) {
                    const originalText = textContent.textContent;
                    const reformattedText = reformatKacaDataWithSpacing(originalText, newSpacing);
                    textContent.textContent = reformattedText;
                }
            });
            
            console.log(`📊 Column spacing changed to ${newSpacing}px`);
            
            // Save column spacing preference to localStorage
            try {
                localStorage.setItem('printColumnSpacing', newSpacing.toString());
                console.log('💾 Column spacing preference saved to localStorage');
            } catch (error) {
                console.error('❌ Error saving column spacing preference:', error);
            }
        }

        // Helper to center-align text within fixed width (monospace)
        function centerPad(value, width) {
            const text = (value ?? '').toString();
            const clipped = text.length > width ? text.slice(0, width) : text;
            const totalPadding = width - clipped.length;
            const leftPadding = Math.floor(totalPadding / 2);
            const rightPadding = totalPadding - leftPadding;
            return ' '.repeat(leftPadding) + clipped + ' '.repeat(rightPadding);
        }

        // Function to reformat kaca-data text with new column spacing
        function reformatKacaDataWithSpacing(text, newConfig) {
            if (!text || text.trim() === '') return text;

            const lines = text.split('\n');
            const reformattedLines = [];

            const columnOrder = ['jenisKaca', 'pwd', 'noDo', 'ukuran', 'box', 'lbr', 'totalLbr'];
            const rightAlignColumns = new Set(['box', 'lbr', 'totalLbr']);
            const centerAlignColumns = new Set(['ukuran']);

            lines.forEach(line => {
                if (line.trim() === '') {
                    reformattedLines.push('');
                    return;
                }

                // Parse the line based on current spacing (existing rendering)
                const columns = [];
                let remainingLine = line;

                columnOrder.forEach(columnName => {
                    const currentWidth = columnSpacingConfig[columnName] || 12;
                    if (remainingLine.length >= currentWidth) {
                        columns.push(remainingLine.substring(0, currentWidth).trim());
                        remainingLine = remainingLine.substring(currentWidth);
                    } else {
                        columns.push(remainingLine.trim());
                        remainingLine = '';
                    }
                });

                // Reformat per newConfig with proper alignment
                const reformattedLine = columns.map((rawValue, index) => {
                    const columnName = columnOrder[index];
                    const width = newConfig[columnName] || 12;
                    const value = (rawValue ?? '').toString();

                    // Clip to width first
                    let clipped;
                    if (rightAlignColumns.has(columnName)) {
                        // Keep least significant part on the right when clipping
                        clipped = value.length > width ? value.slice(-width) : value;
                        return clipped.padStart(width);
                    } else if (centerAlignColumns.has(columnName)) {
                        return centerPad(value, width);
                    } else {
                        clipped = value.length > width ? value.slice(0, width) : value;
                        return clipped.padEnd(width);
                    }
                }).join('');

                reformattedLines.push(reformattedLine);
            });

            return reformattedLines.join('\n');
        }

        // Function to load saved column spacing preference
        function loadColumnSpacingPreference() {
            try {
                const savedSpacing = localStorage.getItem('printColumnSpacing');
                if (savedSpacing) {
                    const spacing = parseInt(savedSpacing);
                    currentColumnSpacing = spacing;
                    
                    // Update select element
                    const spacingSelect = document.getElementById('columnSpacingControl');
                    if (spacingSelect) {
                        spacingSelect.value = spacing;
                    }
                    
                    console.log(`📊 Loaded saved column spacing: ${spacing}px`);
                }
            } catch (error) {
                console.error('❌ Error loading column spacing preference:', error);
            }
        }

        // Function to update column spacing from individual inputs
        function updateColumnSpacing() {
            const newConfig = {
                jenisKaca: parseInt(document.getElementById('colJenisKaca').value) || 15,
                pwd: parseInt(document.getElementById('colPwd').value) || 8,
                noDo: parseInt(document.getElementById('colNoDo').value) || 12,
                ukuran: parseInt(document.getElementById('colUkuran').value) || 12,
                box: parseInt(document.getElementById('colBox').value) || 10,
                lbr: parseInt(document.getElementById('colLbr').value) || 10,
                totalLbr: parseInt(document.getElementById('colTotalLbr').value) || 12
            };
            
            // Update column spacing configuration
            columnSpacingConfig = { ...newConfig };
            
            // Show visual feedback
            showColumnSpacingFeedback();
            
            // Refresh the print data with new spacing
            refreshPrintData();
            
            // Save to localStorage
            saveColumnSpacingToStorage();
            
            console.log('📊 Column spacing updated:', columnSpacingConfig);
        }

        // Function to show visual feedback for column spacing updates
        function showColumnSpacingFeedback() {
            // Add a subtle animation to the print preview area
            const previewArea = document.querySelector('.print-textarea-container');
            if (previewArea) {
                previewArea.style.transition = 'all 0.3s ease';
                previewArea.style.transform = 'scale(1.02)';
                previewArea.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.2)';
                
                setTimeout(() => {
                    previewArea.style.transform = 'scale(1)';
                    previewArea.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.1)';
                }, 300);
            }
            
            // Add visual feedback to the section title
            const sectionTitle = document.querySelector('.controls-section-title');
            if (sectionTitle) {
                sectionTitle.style.color = '#667eea';
                sectionTitle.style.transition = 'color 0.3s ease';
                
                setTimeout(() => {
                    sectionTitle.style.color = '#2c3e50';
                }, 500);
            }
        }

        // Function to apply spacing presets
        function applyPreset(presetName) {
            if (spacingPresets[presetName]) {
                const newConfig = { ...spacingPresets[presetName] };
                columnSpacingConfig = newConfig;
                
                // Update input values
                document.getElementById('colJenisKaca').value = columnSpacingConfig.jenisKaca;
                document.getElementById('colPwd').value = columnSpacingConfig.pwd;
                document.getElementById('colNoDo').value = columnSpacingConfig.noDo;
                document.getElementById('colUkuran').value = columnSpacingConfig.ukuran;
                document.getElementById('colBox').value = columnSpacingConfig.box;
                document.getElementById('colLbr').value = columnSpacingConfig.lbr;
                document.getElementById('colTotalLbr').value = columnSpacingConfig.totalLbr;
                
                // Update preset button states
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                // Show visual feedback
                showColumnSpacingFeedback();
                
                // Refresh the print data with new spacing
                refreshPrintData();
                
                // Save to localStorage
                saveColumnSpacingToStorage();
                
                console.log(`📊 Applied ${presetName} preset:`, columnSpacingConfig);
            }
        }

        // Function to save column spacing to localStorage
        function saveColumnSpacingToStorage() {
            try {
                localStorage.setItem('columnSpacingConfig', JSON.stringify(columnSpacingConfig));
                console.log('💾 Column spacing saved to localStorage');
            } catch (error) {
                console.error('❌ Error saving column spacing:', error);
            }
        }

        // Function to load column spacing from localStorage
        function loadColumnSpacingFromStorage() {
            try {
                const saved = localStorage.getItem('columnSpacingConfig');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    columnSpacingConfig = { ...columnSpacingConfig, ...loaded };
                    
                    // Update input values if they exist
                    if (document.getElementById('colJenisKaca')) {
                        document.getElementById('colJenisKaca').value = columnSpacingConfig.jenisKaca;
                        document.getElementById('colPwd').value = columnSpacingConfig.pwd;
                        document.getElementById('colNoDo').value = columnSpacingConfig.noDo;
                        document.getElementById('colUkuran').value = columnSpacingConfig.ukuran;
                        document.getElementById('colBox').value = columnSpacingConfig.box;
                        document.getElementById('colLbr').value = columnSpacingConfig.lbr;
                        document.getElementById('colTotalLbr').value = columnSpacingConfig.totalLbr;
                    }
                    
                    console.log('📊 Loaded column spacing from localStorage:', columnSpacingConfig);
                }
            } catch (error) {
                console.error('❌ Error loading column spacing:', error);
            }
        }

        // Function to change column spacing (legacy function for backward compatibility)
        function changeColumnSpacing() {
            const spacingSelect = document.getElementById('columnSpacingControl');
            if (spacingSelect) {
                const newSpacing = parseInt(spacingSelect.value);
                currentColumnSpacing = newSpacing;
                
                // Update all column widths to the same value
                const newConfig = {
                    jenisKaca: newSpacing,
                    pwd: newSpacing,
                    noDo: newSpacing,
                    ukuran: newSpacing,
                    box: newSpacing,
                    lbr: newSpacing,
                    totalLbr: newSpacing
                };
                
                // Update column spacing configuration
                columnSpacingConfig = { ...newConfig };
                
                // Update input values
                updateColumnInputs();
                
                // Refresh the print data with new spacing
                refreshPrintData();
                
                // Save to localStorage
                saveColumnSpacingToStorage();
                
                console.log(`📊 Column spacing changed to ${newSpacing}px for all columns`);
            }
        }

        // Function to update column input values
        function updateColumnInputs() {
            const inputs = [
                'colJenisKaca', 'colPwd', 'colNoDo', 'colUkuran', 'colBox', 'colLbr', 'colTotalLbr'
            ];
            
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    const columnName = id.replace('col', '').toLowerCase();
                    if (columnName === 'jeniskaca') columnName = 'jenisKaca';
                    if (columnName === 'nodo') columnName = 'noDo';
                    if (columnName === 'totallbr') columnName = 'totalLbr';
                    
                    input.value = columnSpacingConfig[columnName] || 12;
                }
            });
        }

        // Test function to debug TOTAL LBR issue
        function testKacaData() {
            console.log('🧪 Testing Kaca Data Processing...');
            
            // Check if kaca table exists
            const kacaTable = document.getElementById('kacaTable');
            if (!kacaTable) {
                console.error('❌ Kaca table not found!');
                return;
            }
            
            // Check kaca table body
            const kacaTableBody = document.getElementById('kacaTableBody');
            if (!kacaTableBody) {
                console.error('❌ Kaca table body not found!');
                return;
            }
            
            // Check rows
            const rows = kacaTableBody.querySelectorAll('tr');
            console.log(`📊 Found ${rows.length} rows in kaca table`);
            
            // Debug each row in detail
            rows.forEach((row, index) => {
                console.log(`\n🔍 === ROW ${index + 1} DETAILED ANALYSIS ===`);
                
                // Check row structure
                console.log('Row HTML:', row.outerHTML.substring(0, 300) + '...');
                
                // Check all input elements in the row
                const allInputs = row.querySelectorAll('input');
                console.log(`Found ${allInputs.length} input elements in row ${index + 1}:`);
                
                allInputs.forEach((input, inputIndex) => {
                    const className = input.className;
                    const value = input.value;
                    const placeholder = input.placeholder;
                    console.log(`  Input ${inputIndex + 1}: class="${className}", value="${value}", placeholder="${placeholder}"`);
                });
                
                // Check specific selectors
                const jenisKaca = row.querySelector('.jenis-kaca');
                const pwd = row.querySelector('.pwd');
                const noDo = row.querySelector('.no-do');
                const ukuran = row.querySelector('.ukuran');
                const box = row.querySelector('.box');
                const lbr = row.querySelector('.lbr');
                const totalLbr = row.querySelector('.total-lbr-input');
                
                console.log('Selector results:', {
                    jenisKaca: jenisKaca ? `Found: "${jenisKaca.value}"` : 'NOT FOUND',
                    pwd: pwd ? `Found: "${pwd.value}"` : 'NOT FOUND',
                    noDo: noDo ? `Found: "${noDo.value}"` : 'NOT FOUND',
                    ukuran: ukuran ? `Found: "${ukuran.value}"` : 'NOT FOUND',
                    box: box ? `Found: "${box.value}"` : 'NOT FOUND',
                    lbr: lbr ? `Found: "${lbr.value}"` : 'NOT FOUND',
                    totalLbr: totalLbr ? `Found: "${totalLbr.value}"` : 'NOT FOUND'
                });
                
                // Check if totalLbr has the right class
                if (totalLbr) {
                    console.log('✅ TOTAL LBR input found with classes:', totalLbr.className);
                    console.log('TOTAL LBR value:', `"${totalLbr.value}"`);
                    console.log('TOTAL LBR type:', totalLbr.type);
                    console.log('TOTAL LBR readonly:', totalLbr.readOnly);
                } else {
                    console.log('❌ TOTAL LBR input NOT FOUND!');
                    
                    // Try alternative selectors
                    const alternativeSelectors = [
                        'input[readonly]',
                        '.total-lbr',
                        'input[placeholder*="LBR"]',
                        'td:last-child input'
                    ];
                    
                    alternativeSelectors.forEach(selector => {
                        const alt = row.querySelector(selector);
                        if (alt) {
                            console.log(`🔍 Alternative selector "${selector}" found:`, alt);
                        }
                    });
                }
            });
            
            // Check column spacing configuration
            console.log('\n📏 Column Spacing Config:', columnSpacingConfig);
            
            // Test refreshPrintData function
            console.log('\n🔄 Testing refreshPrintData function...');
            try {
                refreshPrintData();
                console.log('✅ refreshPrintData executed successfully');
            } catch (error) {
                console.error('❌ Error in refreshPrintData:', error);
            }
        }

        // Make test function globally available
        window.testKacaData = testKacaData;

        // Simple function to check TOTAL LBR data quickly
        function quickCheckTotalLBR() {
            console.log('🚀 Quick Check TOTAL LBR Data...');
            
            const kacaTableBody = document.getElementById('kacaTableBody');
            if (!kacaTableBody) {
                console.error('❌ Kaca table body not found!');
                return;
            }
            
            const rows = kacaTableBody.querySelectorAll('tr');
            console.log(`📊 Found ${rows.length} rows`);
            
            let totalSum = 0;
            
            rows.forEach((row, index) => {
                const totalLbrInput = row.querySelector('.total-lbr-input');
                const totalLbrValue = totalLbrInput ? totalLbrInput.value : 'NOT FOUND';
                
                console.log(`Row ${index + 1}: TOTAL LBR = "${totalLbrValue}"`);
                
                if (totalLbrValue && totalLbrValue !== 'NOT FOUND') {
                    const match = totalLbrValue.match(/^(\d+(?:\.\d+)?)/);
                    if (match) {
                        const number = parseFloat(match[1]);
                        totalSum += number;
                        console.log(`  ✅ Added ${number} to total`);
                    }
                }
            });
            
            console.log(`\n🎯 GRAND TOTAL: ${totalSum} LBR`);
            
            // Check if there are any TOTAL LBR inputs at all
            const allTotalInputs = document.querySelectorAll('.total-lbr-input');
            console.log(`\n🔍 Found ${allTotalInputs.length} TOTAL LBR input elements in the entire table`);
            
            allTotalInputs.forEach((input, index) => {
                console.log(`  Input ${index + 1}: value="${input.value}", class="${input.className}", readonly=${input.readOnly}`);
            });
        }

        // Make quick check function globally available
        window.quickCheckTotalLBR = quickCheckTotalLBR;

        // Function to remove header row from kaca data
        function removeHeaderFromKacaData(kacaData) {
            if (!kacaData) return '';
            
            // Split into lines and remove the first line (header)
            const lines = kacaData.split('\n');
            if (lines.length > 1) {
                // Remove first line (header) and any empty lines
                const dataLines = lines.slice(1).filter(line => line.trim() !== '');
                return dataLines.join('\n');
            }
            return '';
        }

        // Function to clean kaca data for printing (no headers, no placeholders)
        function getCleanKacaData() {
            const kacaRows = document.querySelectorAll('#kacaTableBody tr');
            let cleanData = '';
            let totalLbrSum = 0;
            
            kacaRows.forEach((row, index) => {
                const jenisKaca = row.querySelector('.jenis-kaca')?.value || '';
                const pwd = row.querySelector('.pwd')?.value || '';
                const noDo = row.querySelector('.no-do')?.value || '';
                const ukuran = row.querySelector('.ukuran')?.value || '';
                const box = row.querySelector('.box')?.value || '';
                const lbr = row.querySelector('.lbr')?.value || '';
                
                // Try multiple selectors for TOTAL LBR
                let totalLbr = row.querySelector('.total-lbr-input')?.value || '';
                if (!totalLbr) {
                    const altSelectors = [
                        'input.total-lbr-input',
                        'td.total-lbr input',
                        'td:last-child input',
                        'input[readonly]',
                        'input[placeholder*="LBR"]'
                    ];
                    
                    for (const selector of altSelectors) {
                        const altInput = row.querySelector(selector);
                        if (altInput && altInput.value) {
                            totalLbr = altInput.value;
                            break;
                        }
                    }
                }
                
                // Only add rows that have actual data
                const hasData = jenisKaca.trim() || pwd.trim() || noDo.trim() || ukuran.trim() || box.trim() || lbr.trim() || totalLbr.trim();
                
                if (hasData) {
                    const formattedRow = 
                        jenisKaca.padEnd(columnSpacingConfig.jenisKaca) +
                        pwd.padEnd(columnSpacingConfig.pwd) +
                        noDo.padEnd(columnSpacingConfig.noDo) +
                        // Center align ukuran column
                        centerPad(ukuran, columnSpacingConfig.ukuran) +
                        // Right-align numeric columns for better visual alignment
                        box.padStart(columnSpacingConfig.box) +
                        lbr.padStart(columnSpacingConfig.lbr) +
                        totalLbr.padStart(columnSpacingConfig.totalLbr);
                    
                    cleanData += formattedRow + '\n';
                    
                    // Calculate total LBR sum
                    if (totalLbr.trim()) {
                        const match = totalLbr.match(/^(\d+(?:\.\d+)?)/);
                        if (match) {
                            totalLbrSum += parseFloat(match[1]);
                        }
                    }
                }
            });
            
            return { cleanData, totalLbrSum };
        }

        // Get kaca data using clean function (no headers, no placeholders)
        const { cleanData: kacaData, totalLbrSum } = getCleanKacaData();
        
        // New clean version of refreshPrintData (no headers)
        function refreshPrintDataClean() {
            const container = document.querySelector('.print-textarea-container');
            
            // Clear existing content
            container.innerHTML = '';
            
            // Get form data
            const namaToko = document.getElementById('namaToko').value || 'Nama Toko';
            const alamat = document.getElementById('alamat').value || 'Alamat Toko';
            const tanggal = document.getElementById('tanggal').value || 'Tanggal';
            const nomorSJ = document.getElementById('nomorSJ').value || 'No. SJ';
            const supir = document.getElementById('supir').value || 'Nama Supir';
            const noKendaraan = document.getElementById('noKendaraan').value || 'No. Kendaraan';
            
            // Get clean kaca data (no headers, no placeholders)
            const { cleanData: kacaData, totalLbrSum } = getCleanKacaData();
            
            // Debug: Log the final kacaData and totalLbrSum
            console.log('Final kacaData (clean, no headers):', kacaData);
            console.log('Final totalLbrSum:', totalLbrSum);
            
            // Get footer data
            const cont = document.querySelector('.cont-input')?.value || '';
            const seal = document.querySelector('.seal-input')?.value || '';
            
            // Format date
            let formattedDate = 'Tanggal';
            if (tanggal) {
                const date = new Date(tanggal);
                const options = { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                formattedDate = date.toLocaleDateString('id-ID', options);
            }
            
            // Create individual draggable text elements
            const textElements = [
                { text: namaToko, x: 20, y: 40, type: 'header' },
                { text: alamat, x: 20, y: 100, type: 'data' },
                { text: formattedDate, x: 20, y: 160, type: 'data' },
                { text: nomorSJ, x: 20, y: 220, type: 'data' },
                { text: supir, x: 20, y: 280, type: 'data' },
                { text: noKendaraan, x: 20, y: 340, type: 'data' },
                { text: kacaData, x: 20, y: 400, type: 'kaca-data' },
                { text: `${totalLbrSum} LBR`, x: 20, y: 500, type: 'total' },
                { text: cont, x: 20, y: 560, type: 'data' },
                { text: seal, x: 20, y: 620, type: 'data' }
            ];
            
            // Create and position each text element
            textElements.forEach((element, index) => {
                const textDiv = document.createElement('div');
                textDiv.className = 'draggable-text-item';
                
                // Create text content div
                const textContentDiv = document.createElement('div');
                textContentDiv.className = 'text-content';
                textContentDiv.textContent = element.text;
                textDiv.appendChild(textContentDiv);
                
                // Use saved positions if available, otherwise use default positions
                let x, y;
                if (savedPositions[index]) {
                    x = Math.round(savedPositions[index].x);
                    y = Math.round(savedPositions[index].y);
                    console.log(`📍 Using saved position for element ${index}:`, { x, y, text: element.text.substring(0, 30) + '...' });
                } else {
                    x = element.x;
                    y = element.y;
                    console.log(`🆕 Using default position for element ${index}:`, { x, y, text: element.text.substring(0, 30) + '...' });
                }
                
                textDiv.style.left = Math.round(x) + 'px';
                textDiv.style.top = Math.round(y) + 'px';
                textDiv.dataset.index = index;
                textDiv.dataset.type = element.type;
                
                // Debug: Log creation of kaca-data element (index 6)
                if (index === 6) {
                    console.log('🎯 Created kaca-data element (index 6):', {
                        text: element.text.substring(0, 100) + '...',
                        type: element.type,
                        x: x,
                        y: y,
                        className: textDiv.className,
                        dataset: textDiv.dataset
                    });
                }
                
                // Add locked styling if positions are locked
                if (positionsLocked) {
                    textDiv.style.cursor = 'not-allowed';
                    textDiv.classList.add('locked');
                }
                
                // Add special styling for different types
                if (element.type === 'header') {
                    textDiv.style.fontWeight = 'bold';
                    textDiv.style.fontSize = '16px';
                    textDiv.style.color = '#333';
                    textDiv.style.backgroundColor = '#f8f9fa';
                } else if (element.type === 'total') {
                    textDiv.style.fontWeight = 'bold';
                    textDiv.style.color = '#28a745';
                    textDiv.style.borderColor = '#28a745';
                    textDiv.style.backgroundColor = '#f8fff9';
                } else if (element.type === 'kaca-data') {
                    textDiv.style.maxWidth = '600px';
                    textDiv.style.width = 'auto';
                    textDiv.style.whiteSpace = 'pre-wrap';
                    textDiv.style.wordWrap = 'break-word';
                    textDiv.style.fontSize = '12px';
                    textDiv.style.fontFamily = 'Courier New, monospace';
                    textDiv.style.backgroundColor = '#f8f9ff';
                    textDiv.style.padding = '8px 12px';
                    textDiv.style.lineHeight = '1.2';
                    textDiv.style.height = 'auto';
                    textDiv.style.minHeight = 'auto';
                    textDiv.style.border = '2px solid #667eea';
                    textDiv.style.borderRadius = '6px';
                    textDiv.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.15)';
                    
                    // Debug: Log kaca-data element creation
                    console.log('🎯 Created kaca-data element with enhanced styling:', {
                        text: element.text.substring(0, 100) + '...',
                        maxWidth: textDiv.style.maxWidth,
                        backgroundColor: textDiv.style.backgroundColor,
                        border: textDiv.style.border
                    });
                } else if (element.type === 'timestamp') {
                    textDiv.style.fontSize = '11px';
                    textDiv.style.color = '#666';
                    textDiv.style.fontStyle = 'italic';
                    textDiv.style.backgroundColor = '#f9f9f9';
                }
                
                // Special handling for address element (index 1)
                if (index === 1) {
                    textDiv.classList.add('address-element');
                    textDiv.style.whiteSpace = 'pre-wrap';
                    textDiv.style.wordWrap = 'break-word';
                    textDiv.style.maxWidth = '300px';
                    textDiv.style.width = 'auto';
                    textDiv.style.height = 'auto';
                    textDiv.style.minHeight = 'auto';
                    textDiv.style.lineHeight = '1.3';
                    textDiv.style.padding = '6px 10px';
                }

                // Force 8th element (index 7 - total LBR) text color to black in modal preview
                if (index === 7) {
                     textDiv.style.color = '#000';
                     const textContentDivForce = textDiv.querySelector('.text-content');
                     if (textContentDivForce) {
                         textContentDivForce.style.color = '#000';
                     }
                }
                
                // Apply current font size to all elements
                textDiv.style.fontSize = currentFontSize + 'px';
                
                container.appendChild(textDiv);
            });
            
            // Initialize drag and drop for all text elements
            initDragAndDropForElements();
        }

        // Test function to verify no headers in kaca data
        function testNoHeaders() {
            console.log('🧪 Testing No Headers in Kaca Data...');
            
            const { cleanData: kacaData, totalLbrSum } = getCleanKacaData();
            
            console.log('📊 Clean Kaca Data (should have NO headers):');
            console.log('Data length:', kacaData.length);
            console.log('Data content:', kacaData);
            
            // Check if any line contains header text
            const lines = kacaData.split('\n');
            const hasHeaders = lines.some(line => 
                line.includes('JENIS KACA') || 
                line.includes('PWD') || 
                line.includes('NO DO') || 
                line.includes('UKURAN') || 
                line.includes('BOX') || 
                line.includes('LBR') || 
                line.includes('TOTAL LBR')
            );
            
            if (hasHeaders) {
                console.log('❌ HEADERS FOUND! Kaca data still contains column titles');
            } else {
                console.log('✅ NO HEADERS FOUND! Kaca data is clean');
            }
            
            console.log('🎯 Total LBR Sum:', totalLbrSum);
            
            return { kacaData, totalLbrSum, hasHeaders };
        }
        
        // Make test function globally available
        window.testNoHeaders = testNoHeaders;

        // Input Log System
        let inputLogHistory = [];
        // Track last entered No. SJ to warn on duplicates
        let lastNomorSJ = '';
        try {
            lastNomorSJ = (localStorage.getItem('lastNomorSJ') || '').trim();
        } catch (_) {
            lastNomorSJ = '';
        }

        // Load input log from localStorage on page load
        function loadInputLogFromStorage() {
            try {
                const saved = localStorage.getItem('inputLogHistory');
                if (saved) {
                    inputLogHistory = JSON.parse(saved);
                    console.log('✅ Loaded input log from localStorage:', inputLogHistory.length, 'entries');
                    renderInputLog();
                } else {
                    console.log('ℹ️ No input log found in localStorage');
                }
            } catch (error) {
                console.error('❌ Error loading input log:', error);
                inputLogHistory = [];
            }
        }

        // Save input log to localStorage
        function saveInputLogToStorage() {
            try {
                localStorage.setItem('inputLogHistory', JSON.stringify(inputLogHistory));
                console.log('💾 Input log saved to localStorage:', inputLogHistory.length, 'entries');
                // Update suggestion datalists whenever log changes
                updateKacaSuggestionsFromLogs();
                if (typeof window.refreshNomorSJWarningNow === 'function') {
                    window.refreshNomorSJWarningNow();
                }
            } catch (error) {
                console.error('❌ Error saving input log:', error);
            }
        }

        // Save current form input to log
        function saveCurrentInputToLog() {
            const namaToko = document.getElementById('namaToko').value.trim();
            const alamat = document.getElementById('alamat').value.trim();
            const alias = (document.getElementById('alias')?.value || '').trim();
            const tanggal = document.getElementById('tanggal').value;
            const nomorSJ = document.getElementById('nomorSJ').value.trim();
            const supir = document.getElementById('supir').value.trim();
            const noKendaraan = document.getElementById('noKendaraan').value.trim();
            
            // Check if required fields are filled
            if (!namaToko || !tanggal || !nomorSJ || !supir || !noKendaraan) {
                alert('Mohon lengkapi semua field yang wajib diisi sebelum menyimpan log!');
                return;
            }
            
            // Get kaca data
            const kacaData = getKacaDataForLog();
            
            // Create log entry
            const logEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                data: {
                    namaToko,
                    alias,
                    alamat,
                    tanggal,
                    nomorSJ,
                    supir,
                    noKendaraan,
                    kacaData
                }
            };
            
            // Add to beginning of array (newest first)
            inputLogHistory.unshift(logEntry);
            
            // Keep only last 50 entries to prevent memory issues
            if (inputLogHistory.length > 50) {
                inputLogHistory = inputLogHistory.slice(0, 50);
            }
            
            // Save to localStorage
            saveInputLogToStorage();
            // Update lastNomorSJ AFTER successful save/print
            try { localStorage.setItem('lastNomorSJ', nomorSJ); } catch (_) {}
            lastNomorSJ = nomorSJ;
            
            // Render the log
            renderInputLog();
            
            // Optional: toast could be added here if needed
            
            console.log('💾 Saved input log entry:', logEntry);
        }

        // Helper: check if No. SJ exists in input log
        function isNomorSJInLog(nomor) {
            try {
                const val = (nomor || '').trim();
                if (!val) return false;
                return (inputLogHistory || []).some(entry => ((entry.data?.nomorSJ || '').trim() === val));
            } catch (_) { return false; }
        }

        // Warn if No. SJ duplicates an existing log entry
        document.addEventListener('DOMContentLoaded', function() {
            const nomorSJInput = document.getElementById('nomorSJ');
            const warningEl = document.getElementById('nomorSJWarning');
            if (!nomorSJInput) return;

            let nomorSJWarningTimer = null;
            function applyNomorSJWarningVisibility() {
                const current = nomorSJInput.value.trim();
                const isDuplicate = !!current && isNomorSJInLog(current);
                if (isDuplicate) {
                    warningEl.style.display = 'flex';
                    nomorSJInput.classList.add('has-warning');
                } else {
                    warningEl.style.display = 'none';
                    nomorSJInput.classList.remove('has-warning');
                }
            }

            nomorSJInput.addEventListener('input', function() {
                const current = nomorSJInput.value.trim();
                // Clear immediately when not duplicate; debounce when duplicate
                if (!current || !isNomorSJInLog(current)) {
                    warningEl.style.display = 'none';
                    nomorSJInput.classList.remove('has-warning');
                }
                // Debounce showing warning when equal to last value
                if (nomorSJWarningTimer) clearTimeout(nomorSJWarningTimer);
                nomorSJWarningTimer = setTimeout(() => {
                    applyNomorSJWarningVisibility();
                }, 500);
            });
            // Validate on blur without updating lastNomorSJ to avoid false warnings
            nomorSJInput.addEventListener('blur', function() {
                if (nomorSJWarningTimer) clearTimeout(nomorSJWarningTimer);
                applyNomorSJWarningVisibility();
            });

            // Expose refresh function globally and initialize state on load
            window.refreshNomorSJWarningNow = applyNomorSJWarningVisibility;
            applyNomorSJWarningVisibility();
        });

        // Function to get kaca data for log
        function getKacaDataForLog() {
            const kacaRows = document.querySelectorAll('#kacaTableBody tr');
            const kacaData = [];
            
            kacaRows.forEach((row, index) => {
                const jenisKaca = row.querySelector('.jenis-kaca')?.value || '';
                const pwd = row.querySelector('.pwd')?.value || '';
                const noDo = row.querySelector('.no-do')?.value || '';
                const ukuran = row.querySelector('.ukuran')?.value || '';
                const box = row.querySelector('.box')?.value || '';
                const lbr = row.querySelector('.lbr')?.value || '';
                
                // Try multiple selectors for TOTAL LBR
                let totalLbr = row.querySelector('.total-lbr-input')?.value || '';
                if (!totalLbr) {
                    const altSelectors = [
                        'input.total-lbr-input',
                        'td.total-lbr input',
                        'td:last-child input',
                        'input[readonly]',
                        'input[placeholder*="LBR"]'
                    ];
                    
                    for (const selector of altSelectors) {
                        const altInput = row.querySelector(selector);
                        if (altInput && altInput.value) {
                            totalLbr = altInput.value;
                            break;
                        }
                    }
                }
                
                // Only add rows that have actual data
                const hasData = jenisKaca.trim() || pwd.trim() || noDo.trim() || ukuran.trim() || box.trim() || lbr.trim() || totalLbr.trim();
                
                if (hasData) {
                    kacaData.push({
                        jenisKaca: jenisKaca.trim(),
                        pwd: pwd.trim(),
                        noDo: noDo.trim(),
                        ukuran: ukuran.trim(),
                        box: box.trim(),
                        lbr: lbr.trim(),
                        totalLbr: totalLbr.trim()
                    });
                }
            });
            
            // Get footer data (CONT and SEAL)
            const contInput = document.querySelector('.cont-input');
            const sealInput = document.querySelector('.seal-input');
            const grandTotalInput = document.querySelector('.grand-total-input');
            
            const footerData = {
                cont: contInput ? contInput.value.trim() : '',
                seal: sealInput ? sealInput.value.trim() : '',
                grandTotal: grandTotalInput ? grandTotalInput.value.trim() : ''
            };
            
            return {
                rows: kacaData,
                footer: footerData
            };
        }

        // Current search query state
        let currentLogSearchQuery = '';

        function applyLogSearch() {
            const input = document.getElementById('logSearchInput');
            currentLogSearchQuery = (input && input.value ? input.value : '').trim().toLowerCase();
            renderInputLog();
        }

        // Render input log entries (respects currentLogSearchQuery)
        function renderInputLog() {
            const container = document.getElementById('inputLogContainer');
            
            if (inputLogHistory.length === 0) {
                container.innerHTML = `
                    <div class="no-log-message">
                        <p>Belum ada log input</p>
                        <p class="log-hint">Log akan tersimpan otomatis saat Anda menekan Print Sekarang</p>
                    </div>
                `;
                return;
            }
            
            // Filter by search query if present
            let filtered = inputLogHistory;
            if (currentLogSearchQuery) {
                const q = currentLogSearchQuery;
                filtered = inputLogHistory.filter(entry => {
                    try {
                        const d = entry.data || {};
                        const fields = [
                            d.namaToko,
                            d.alias,
                            d.alamat,
                            d.tanggal,
                            d.nomorSJ,
                            d.supir,
                            d.noKendaraan
                        ].map(v => (v || '').toString().toLowerCase());

                        // Search inside kaca rows too
                        const kaca = d.kacaData || {};
                        const rows = Array.isArray(kaca) ? kaca : (kaca.rows || []);
                        const rowsText = rows.map(r => [r.jenisKaca, r.pwd, r.noDo, r.ukuran, r.box, r.lbr, r.totalLbr]
                            .map(v => (v || '').toString().toLowerCase()).join(' ')).join(' ');

                        return fields.some(text => text.includes(q)) || rowsText.includes(q);
                    } catch (_) { return false; }
                });
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="no-log-message">
                        <p>Tidak ada hasil untuk pencarian tersebut</p>
                        <p class="log-hint">Coba kata kunci lain atau kosongkan pencarian</p>
                    </div>
                `;
                return;
            }

            let html = '';
            filtered.forEach((entry) => {
                const timestamp = new Date(entry.timestamp).toLocaleString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Format date for compact display
                const compactDate = new Date(entry.data.tanggal).toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                
                // Format kaca data for display
                const kacaDataDisplay = formatKacaDataForDisplay(entry.data.kacaData);
                
                html += `
                    <div class="log-entry" onclick="toggleLogDetailsById(${entry.id})" title="Klik untuk melihat detail lengkap">
                        <div class="log-entry-header">
                            <span class="log-timestamp">${timestamp}</span>
                            <span class="log-toggle-icon">📋</span>
                        </div>
                        
                        <!-- Default view (compact single line) -->
                        <div class="log-content-default" id="log-default-${entry.id}">
                            <div class="log-compact-line">
                                <span class="log-compact-item">
                                    <span class="log-compact-label">🏪</span>
                                    <span class="log-compact-value">${entry.data.namaToko}</span>
                                </span>
                                ${entry.data.alias ? `
                                <span class="log-compact-separator">|</span>
                                <span class="log-compact-item">
                                    <span class="log-compact-label">🏷️</span>
                                    <span class="log-compact-value">${entry.data.alias}</span>
                                </span>` : ''}
                                <span class="log-compact-separator">|</span>
                                <span class="log-compact-item">
                                    <span class="log-compact-label">📅</span>
                                    <span class="log-compact-value">${compactDate}</span>
                                </span>
                                <span class="log-compact-separator">|</span>
                                <span class="log-compact-item">
                                    <span class="log-compact-label">📄</span>
                                    <span class="log-compact-value">${entry.data.nomorSJ}</span>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Detailed view (hidden by default) -->
                        <div class="log-content-detailed" id="log-detailed-${entry.id}" style="display: none;">
                            <div class="log-item">
                                <span class="log-label">Nama Toko</span>
                                <span class="log-sep">:</span>
                                <span class="log-value">${entry.data.namaToko}</span>
                            </div>
                            <div class="log-item">
                                <span class="log-label">Alias</span>
                                <span class="log-sep">:</span>
                                <span class="log-value">${entry.data.alias || '-'}</span>
                            </div>
                            <div class="log-item">
                                <span class="log-label">Tanggal</span>
                                <span class="log-sep">:</span>
                                <span class="log-value">${formatDateForDisplay(entry.data.tanggal)}</span>
                            </div>
                            <div class="log-item">
                                <span class="log-label">No. SJ</span>
                                <span class="log-sep">:</span>
                                <span class="log-value">${entry.data.nomorSJ}</span>
                            </div>
                            <div class="log-item">
                                <span class="log-label">Supir</span>
                                <span class="log-sep">:</span>
                                <span class="log-value">${entry.data.supir}</span>
                            </div>
                            <div class="log-item">
                                <span class="log-label">No. Kendaraan</span>
                                <span class="log-sep">:</span>
                                <span class="log-value">${entry.data.noKendaraan}</span>
                            </div>
                            <div class="log-item">
                                <span class="log-label">Alamat</span>
                                <span class="log-sep">:</span>
                                <span class="log-value">${entry.data.alamat || 'Tidak ada alamat'}</span>
                            </div>
                            <div class="log-item">
                                <span class="log-label">Data Kaca</span>
                                <span class="log-sep">:</span>
                                <span class="log-value">${kacaDataDisplay}</span>
                            </div>
                            
                            <!-- Action buttons for detailed view -->
                            <div class="log-actions-detailed">
                                <button type="button" class="btn-load-data" onclick="loadInputFromLogById(${entry.id}); event.stopPropagation();" title="Muat data ke form">
                                    🔄 Muat ke Form
                                </button>
                                <button type="button" class="btn-edit-log" onclick="editLogEntryById(${entry.id}); event.stopPropagation();" title="Edit log ini">
                                    ✏️ Edit
                                </button>
                                <button type="button" class="btn-delete-log" onclick="deleteLogEntryById(${entry.id}); event.stopPropagation();" title="Hapus log ini">
                                    🗑️ Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Function to format kaca data for display in log
        function formatKacaDataForDisplay(kacaData) {
            if (!kacaData || !kacaData.rows || kacaData.rows.length === 0) {
                return 'Tidak ada data kaca';
            }
            
            const rows = kacaData.rows;
            const footer = kacaData.footer;
            
            let displayText = '';
            
            if (rows.length === 1) {
                const row = rows[0];
                displayText = `${row.jenisKaca} - ${row.ukuran} - ${row.totalLbr}`;
            } else {
                displayText = `${rows.length} baris data kaca (Total: ${calculateTotalFromKacaData(rows)} LBR)`;
            }
            
            // Add footer information (exclude grand total to avoid duplicate Total LBR)
            if (footer.cont || footer.seal) {
                const footerInfo = [];
                if (footer.cont) footerInfo.push(`CONT: ${footer.cont}`);
                if (footer.seal) footerInfo.push(`SEAL: ${footer.seal}`);
                
                if (footerInfo.length > 0) {
                    displayText += ` | ${footerInfo.join(', ')}`;
                }
            }
            
            return displayText;
        }

        // Function to calculate total from kaca data
        function calculateTotalFromKacaData(kacaData) {
            let total = 0;
            
            // Handle both old format (array) and new format (object with rows)
            const rows = Array.isArray(kacaData) ? kacaData : (kacaData.rows || []);
            
            rows.forEach(row => {
                if (row.totalLbr) {
                    const match = row.totalLbr.match(/^(\d+(?:\.\d+)?)/);
                    if (match) {
                        total += parseFloat(match[1]);
                    }
                }
            });
            
            return Math.round(total);
        }

        // Load input from log entry to form
        function loadInputFromLog(index) {
            const entry = inputLogHistory[index];
            if (!entry) return;
            
            // Fill form fields
            document.getElementById('namaToko').value = entry.data.namaToko;
            const aliasField = document.getElementById('alias');
            if (aliasField) aliasField.value = entry.data.alias || '';
            document.getElementById('alamat').value = entry.data.alamat;
            document.getElementById('tanggal').value = entry.data.tanggal;
            document.getElementById('nomorSJ').value = entry.data.nomorSJ;
            document.getElementById('supir').value = entry.data.supir;
            document.getElementById('noKendaraan').value = entry.data.noKendaraan;
            
            // Load kaca data if available
            if (entry.data.kacaData) {
                // Handle both old format (array) and new format (object with rows)
                const hasData = Array.isArray(entry.data.kacaData) ? 
                    entry.data.kacaData.length > 0 : 
                    (entry.data.kacaData.rows && entry.data.kacaData.rows.length > 0);
                
                if (hasData) {
                    loadKacaDataFromLog(entry.data.kacaData);
                    console.log('🔄 Loading kaca data from log entry:', entry.data.kacaData);
                } else {
                    console.log('ℹ️ No kaca data found in log entry');
                }
            } else {
                console.log('ℹ️ No kacaData field in log entry');
            }
            
            // Auto-resize textarea
            const alamatField = document.getElementById('alamat');
            if (alamatField) {
                autoResizeTextarea(alamatField);
            }
            
            // Show success message
            alert(`Form telah diisi dengan data dari log: ${entry.data.namaToko}`);
            
            console.log('🔄 Loaded input from log entry:', entry);
        }

        // Function to load kaca data from log
        function loadKacaDataFromLog(kacaData) {
            const tbody = document.getElementById('kacaTableBody');
            if (!tbody) return;
            
            // Handle both old format (array) and new format (object with rows)
            const rows = Array.isArray(kacaData) ? kacaData : (kacaData.rows || []);
            const footer = kacaData.footer || {};
            
            // Clear existing rows
            tbody.innerHTML = '';
            
            // Add rows based on log data
            rows.forEach((rowData, index) => {
                const newRow = document.createElement('tr');
                const rowId = Date.now() + Math.random();
                
                // Build cells without embedding unescaped values
                newRow.innerHTML = `
                    <td>
                        <input type="text" placeholder="Jenis Kaca" class="jenis-kaca" onchange="calculateTotalLbr(this)" list="datalistJenisKaca" autocomplete="off" autocapitalize="none" spellcheck="false">
                    </td>
                    <td class="pwd-input">
                        <input type="text" placeholder="PWD" class="pwd" maxlength="3">
                    </td>
                    <td class="no-do-input">
                        <input type="text" placeholder="No DO" class="no-do">
                    </td>
                    <td>
                        <input type="text" placeholder="Ukuran" class="ukuran" onchange="calculateTotalLbr(this)" list="datalistUkuran" autocomplete="off" autocapitalize="none" spellcheck="false">
                    </td>
                    <td class="box-input">
                        <input type="text" placeholder="0 BOX" class="box" onchange="calculateTotalLbr(this)" oninput="calculateTotalLbr(this)">
                    </td>
                    <td class="lbr-input">
                        <input type="text" placeholder="0 LBR" class="lbr" onchange="calculateTotalLbr(this)" oninput="calculateTotalLbr(this)">
                    </td>
                    <td class="total-lbr total-lbr-input">
                        <input type="text" placeholder="0 LBR" class="total-lbr-input" readonly>
                    </td>
                `;
                
                // Assign values safely to avoid HTML attribute issues with quotes
                const jenisEl = newRow.querySelector('.jenis-kaca');
                const pwdEl = newRow.querySelector('.pwd');
                const noDoEl = newRow.querySelector('.no-do');
                const ukuranEl = newRow.querySelector('.ukuran');
                const boxEl = newRow.querySelector('.box');
                const lbrEl = newRow.querySelector('.lbr');
                const totalEl = newRow.querySelector('.total-lbr-input');
                if (jenisEl) jenisEl.value = rowData.jenisKaca || '';
                if (pwdEl) pwdEl.value = rowData.pwd || '';
                if (noDoEl) noDoEl.value = rowData.noDo || '';
                if (ukuranEl) ukuranEl.value = rowData.ukuran || '';
                if (boxEl) boxEl.value = rowData.box || '';
                if (lbrEl) lbrEl.value = rowData.lbr || '';
                if (totalEl) totalEl.value = rowData.totalLbr || '';
                
                // Recalculate row total to ensure correct value after loading
                // Using lbr input as reference; function will read both BOX and LBR
                if (typeof calculateTotalLbr === 'function' && (boxEl || lbrEl)) {
                    const refInput = lbrEl || boxEl;
                    try { calculateTotalLbr(refInput); } catch (_) {}
                }
                
                tbody.appendChild(newRow);
            });
            
            // Load footer data (CONT and SEAL)
            if (footer.cont) {
                const contInput = document.querySelector('.cont-input');
                if (contInput) contInput.value = footer.cont;
            }
            
            if (footer.seal) {
                const sealInput = document.querySelector('.seal-input');
                if (sealInput) sealInput.value = footer.seal;
            }
            
            // Update grand total and refresh print data after rows populated
            setTimeout(() => {
                try { updateGrandTotal(); } catch (_) {}
                const printModal = document.getElementById('printModalOverlay');
                if (printModal && printModal.style.display === 'flex') {
                    try { refreshPrintData(); } catch (_) {}
                }
            }, 150);
            
            console.log('🔄 Loaded kaca data from log:', { rows, footer });
        }

        // Export input log to file
        // Removed exportInputLog (not used anymore)

        // Function to format kaca data for CSV export
        // Removed formatKacaDataForCSV (not used anymore)

        // Clear all input logs
        function clearInputLog() {
            if (confirm('Apakah Anda yakin ingin menghapus semua log input? Tindakan ini tidak dapat dibatalkan.')) {
                inputLogHistory = [];
                saveInputLogToStorage();
                renderInputLog();
                alert('Semua log input telah dihapus!');
                console.log('🗑️ Cleared all input logs');
            }
        }

        // Edit a specific log entry: load into form for editing and remove the old entry (will be re-saved on next print)
        function editLogEntry(index) {
            const entry = inputLogHistory[index];
            if (!entry) return;
            // Load to form
            loadInputFromLog(index);
            // Remove the entry so next save creates updated version at top
            inputLogHistory.splice(index, 1);
            saveInputLogToStorage();
            renderInputLog();
            alert('Log dimuat ke form untuk diedit. Setelah selesai, tekan Print Sekarang untuk menyimpan perubahan.');
        }

        // Delete a specific log entry
        function deleteLogEntry(index) {
            const entry = inputLogHistory[index];
            if (!entry) return;
            if (confirm('Hapus log ini? Tindakan ini tidak dapat dibatalkan.')) {
                inputLogHistory.splice(index, 1);
                saveInputLogToStorage();
                renderInputLog();
                alert('Log berhasil dihapus.');
            }
        }

        // Helper function to format date for display
        function formatDateForDisplay(dateString) {
            if (!dateString) return 'Tidak ada tanggal';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        }

        // Load input log when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadInputLogFromStorage();
            // Build initial suggestions (once after initial log load)
            updateKacaSuggestionsFromLogs();
            // Disable browser autocomplete on existing inputs to avoid duplicate dropdowns
            document.querySelectorAll('input.jenis-kaca, input.ukuran').forEach(el => {
                el.setAttribute('autocomplete', 'off');
                el.setAttribute('autocapitalize', 'none');
                el.setAttribute('spellcheck', 'false');
            });
        });

        // Export input log to CSV (Excel compatible)
        function exportInputLogToCSV() {
            if (!inputLogHistory || inputLogHistory.length === 0) {
                alert('Tidak ada log untuk diexport.');
                return;
            }

            const header = [
                'timestamp','namaToko','alias','alamat','tanggal','nomorSJ','supir','noKendaraan','kacaRows','kacaFooterCont','kacaFooterSeal','kacaFooterGrandTotal'
            ];

            const lines = [header.join(',')];

            inputLogHistory.forEach(entry => {
                const d = entry.data || {};
                const kaca = d.kacaData || {};
                const rows = Array.isArray(kaca) ? kaca : (kaca.rows || []);
                const footer = kaca.footer || {};

                // Serialize kaca rows as single string with pipes
                const rowsStr = rows.map(r => {
                    const vals = [r.jenisKaca||'', r.pwd||'', r.noDo||'', r.ukuran||'', r.box||'', r.lbr||'', r.totalLbr||''];
                    return vals.map(v => (''+v).replace(/\n/g,' ').replace(/\r/g,' ').replace(/\|/g,'/')).join('|');
                }).join('||');

                const rec = [
                    entry.timestamp || '',
                    d.namaToko || '',
                    d.alias || '',
                    (d.alamat||'').replace(/\n/g,'\\n'),
                    d.tanggal || '',
                    d.nomorSJ || '',
                    d.supir || '',
                    d.noKendaraan || '',
                    rowsStr,
                    footer.cont || '',
                    footer.seal || '',
                    footer.grandTotal || ''
                ];

                // CSV escape each field (wrap in quotes and escape quotes)
                const csvLine = rec.map(val => '"' + (''+val).replace(/"/g,'""') + '"').join(',');
                lines.push(csvLine);
            });

            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'input_log_history.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Handle import CSV for input log
        function handleImportLogFile(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    importInputLogFromCSV(text);
                    alert('Import log berhasil.');
                } catch (err) {
                    console.error('Import CSV error:', err);
                    alert('Gagal import CSV: ' + err.message);
                } finally {
                    // reset input so same file can be chosen again later
                    event.target.value = '';
                }
            };
            reader.readAsText(file, 'utf-8');
        }

        function importInputLogFromCSV(csvText) {
            const lines = csvText.replace(/\r/g, '').split('\n').filter(l => l.trim().length > 0);
            if (lines.length <= 1) throw new Error('CSV kosong');
            const header = parseCSVLine(lines[0]).map(h => h.replace(/^\"|\"$/g,''));

            // Support both old CSVs (without 'alias') and new ones (with 'alias')
            const required = ['timestamp','namaToko','alamat','tanggal','nomorSJ','supir','noKendaraan','kacaRows'];
            for (const key of required) {
                if (!header.includes(key)) throw new Error('Header CSV tidak valid, kurang kolom: ' + key);
            }

            const hidx = Object.fromEntries(header.map((h,i)=>[h,i]));
            const imported = [];

            for (let i = 1; i < lines.length; i++) {
                const row = parseCSVLine(lines[i]);
                if (!row || row.length === 0) continue;
                const safe = idx => (row[hidx[idx]] || '').replace(/^\"|\"$/g,'');

                const timestamp = safe('timestamp');
                const namaToko = safe('namaToko');
                const alias = header.includes('alias') ? safe('alias') : '';
                const alamat = safe('alamat').replace(/\\n/g, '\n');
                const tanggal = safe('tanggal');
                const nomorSJ = safe('nomorSJ');
                const supir = safe('supir');
                const noKendaraan = safe('noKendaraan');
                const kacaRows = safe('kacaRows');
                const kacaFooterCont = safe('kacaFooterCont');
                const kacaFooterSeal = safe('kacaFooterSeal');
                const kacaFooterGrandTotal = safe('kacaFooterGrandTotal');

                const rows = kacaRows.split('||').filter(Boolean).map(r => {
                    const parts = r.split('|');
                    return {
                        jenisKaca: parts[0] || '',
                        pwd: parts[1] || '',
                        noDo: parts[2] || '',
                        ukuran: parts[3] || '',
                        box: parts[4] || '',
                        lbr: parts[5] || '',
                        totalLbr: parts[6] || ''
                    };
                });

                const entry = {
                    id: Date.now() + i,
                    timestamp: timestamp || new Date().toISOString(),
                    data: {
                        namaToko,
                        alias,
                        alamat,
                        tanggal,
                        nomorSJ,
                        supir,
                        noKendaraan,
                        kacaData: {
                            rows,
                            footer: {
                                cont: kacaFooterCont,
                                seal: kacaFooterSeal,
                                grandTotal: kacaFooterGrandTotal
                            }
                        }
                    }
                };
                imported.push(entry);
            }

            // Merge strategy: append imported at the beginning (newer first)
            inputLogHistory = [...imported, ...inputLogHistory];
            // Keep at most 500 to avoid overgrowth
            if (inputLogHistory.length > 500) {
                inputLogHistory = inputLogHistory.slice(0, 500);
            }

            saveInputLogToStorage();
            renderInputLog();
            updateKacaSuggestionsFromLogs();
        }

        // Simple CSV line parser handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i+1] === '"') { // escaped quote
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Maintain unique suggestions for Jenis Kaca and Ukuran (case-insensitive, trimmed)
        function updateKacaSuggestionsFromLogs() {
            try {
                const jenisMap = new Map(); // key: normalized, value: display
                const ukuranMap = new Map();

                const normalize = (s) => String(s || '')
                    .toLowerCase()
                    .replace(/\s+/g, ' ')
                    .trim();

                (inputLogHistory || []).forEach(entry => {
                    const rows = Array.isArray(entry.data?.kacaData) ? entry.data.kacaData : (entry.data?.kacaData?.rows || []);
                    rows.forEach(row => {
                        if (row.jenisKaca) {
                            const disp = String(row.jenisKaca).trim();
                            const key = normalize(disp);
                            if (key && !jenisMap.has(key)) jenisMap.set(key, disp);
                        }
                        if (row.ukuran) {
                            const disp = String(row.ukuran).trim();
                            const key = normalize(disp);
                            if (key && !ukuranMap.has(key)) ukuranMap.set(key, disp);
                        }
                    });
                });

                const sortCI = (a, b) => a.toLowerCase().localeCompare(b.toLowerCase());
                const jenisValues = Array.from(jenisMap.values()).sort(sortCI);
                const ukuranValues = Array.from(ukuranMap.values()).sort(sortCI);

                const toOptionHTML = (v) => `<option value="${v.replace(/"/g, '&quot;')}"></option>`;

                const jenisList = document.getElementById('datalistJenisKaca');
                const ukuranList = document.getElementById('datalistUkuran');
                if (jenisList) jenisList.innerHTML = jenisValues.map(toOptionHTML).join('');
                if (ukuranList) ukuranList.innerHTML = ukuranValues.map(toOptionHTML).join('');
            } catch (e) {
                console.warn('Failed updating kaca suggestions:', e);
            }
        }

        // Removed testLogKacaData (not used anymore)

        // Make test function globally available
        // Removed window.testLogKacaData binding

        // Simple test function to verify log kaca data
        // Removed quickTestLogKaca (not used anymore)

        // Make quick test function globally available
        // Removed window.quickTestLogKaca binding

        // Test function to verify auto-fill kaca data from log
        function testAutoFillKacaData() {
            console.log('🧪 Testing Auto-Fill Kaca Data from Log...');
            
            // Check if there are any log entries
            if (inputLogHistory.length === 0) {
                console.log('❌ No log entries found. Please save a log first.');
                return;
            }
            
            // Get the first log entry
            const firstLog = inputLogHistory[0];
            console.log('📊 First log entry:', firstLog);
            
            // Check if it has kaca data
            if (!firstLog.data.kacaData) {
                console.log('❌ No kacaData found in log entry');
                return;
            }
            
            console.log('✅ Kaca data found in log entry:', firstLog.data.kacaData);
            
            // Test the auto-fill function
            console.log('🔄 Testing auto-fill function...');
            
            // Clear current form first
            document.getElementById('namaToko').value = '';
            document.getElementById('alamat').value = '';
            document.getElementById('tanggal').value = '';
            document.getElementById('nomorSJ').value = '';
            document.getElementById('supir').value = '';
            document.getElementById('noKendaraan').value = '';
            
            // Clear kaca table
            const tbody = document.getElementById('kacaTableBody');
            if (tbody) {
                tbody.innerHTML = '';
            }
            
            // Clear footer inputs
            const contInput = document.querySelector('.cont-input');
            const sealInput = document.querySelector('.seal-input');
            if (contInput) contInput.value = '';
            if (sealInput) sealInput.value = '';
            
            console.log('🧹 Form cleared for testing');
            
            // Now test the auto-fill
            setTimeout(() => {
                console.log('🔄 Calling loadInputFromLog(0)...');
                loadInputFromLog(0);
                
                // Check results after a delay
                setTimeout(() => {
                    console.log('🔍 Checking auto-fill results...');
                    
                    // Check form fields
                    const namaToko = document.getElementById('namaToko').value;
                    const alamat = document.getElementById('alamat').value;
                    const tanggal = document.getElementById('tanggal').value;
                    const nomorSJ = document.getElementById('nomorSJ').value;
                    const supir = document.getElementById('supir').value;
                    const noKendaraan = document.getElementById('noKendaraan').value;
                    
                    console.log('📝 Form fields filled:', {
                        namaToko: namaToko || 'empty',
                        alamat: alamat || 'empty',
                        tanggal: tanggal || 'empty',
                        nomorSJ: nomorSJ || 'empty',
                        supir: supir || 'empty',
                        noKendaraan: noKendaraan || 'empty'
                    });
                    
                    // Check kaca table
                    const kacaRows = document.querySelectorAll('#kacaTableBody tr');
                    console.log('📊 Kaca table rows after auto-fill:', kacaRows.length);
                    
                    if (kacaRows.length > 0) {
                        console.log('✅ Kaca data auto-filled successfully');
                        
                        // Check first row data
                        const firstRow = kacaRows[0];
                        const jenisKaca = firstRow.querySelector('.jenis-kaca')?.value || '';
                        const pwd = firstRow.querySelector('.pwd')?.value || '';
                        const noDo = firstRow.querySelector('.no-do')?.value || '';
                        const ukuran = firstRow.querySelector('.ukuran')?.value || '';
                        const box = firstRow.querySelector('.box')?.value || '';
                        const lbr = firstRow.querySelector('.lbr')?.value || '';
                        const totalLbr = firstRow.querySelector('.total-lbr-input')?.value || '';
                        
                        console.log('🔍 First kaca row data:', {
                            jenisKaca: jenisKaca || 'empty',
                            pwd: pwd || 'empty',
                            noDo: noDo || 'empty',
                            ukuran: ukuran || 'empty',
                            box: box || 'empty',
                            lbr: lbr || 'empty',
                            totalLbr: totalLbr || 'empty'
                        });
                    } else {
                        console.log('❌ No kaca rows found after auto-fill');
                    }
                    
                    // Check footer data
                    const contValue = contInput ? contInput.value : '';
                    const sealValue = sealInput ? sealInput.value : '';
                    
                    console.log('📋 Footer data after auto-fill:', {
                        cont: contValue || 'empty',
                        seal: sealValue || 'empty'
                    });
                    
                    if (contValue || sealValue) {
                        console.log('✅ Footer data auto-filled successfully');
                    } else {
                        console.log('ℹ️ No footer data to auto-fill');
                    }
                    
                }, 1000);
                
            }, 500);
            
            console.log('🧪 Auto-fill test completed');
        }

        // Make test function globally available
        window.testAutoFillKacaData = testAutoFillKacaData;

        // Debug function to check auto-fill issue
        function debugAutoFillIssue() {
            console.log('🐛 Debugging Auto-Fill Issue...');
            
            // Check if there are log entries
            console.log('📊 Number of log entries:', inputLogHistory.length);
            
            if (inputLogHistory.length > 0) {
                const firstLog = inputLogHistory[0];
                console.log('📋 First log entry structure:', firstLog);
                
                // Check kaca data structure
                if (firstLog.data.kacaData) {
                    console.log('✅ kacaData exists in log entry');
                    console.log('📊 kacaData type:', typeof firstLog.data.kacaData);
                    console.log('📊 kacaData is array:', Array.isArray(firstLog.data.kacaData));
                    console.log('📊 kacaData content:', firstLog.data.kacaData);
                    
                    if (Array.isArray(firstLog.data.kacaData)) {
                        console.log('📊 Array length:', firstLog.data.kacaData.length);
                    } else if (firstLog.data.kacaData.rows) {
                        console.log('📊 Rows length:', firstLog.data.kacaData.rows.length);
                        console.log('📊 Footer data:', firstLog.data.kacaData.footer);
                    }
                } else {
                    console.log('❌ No kacaData in log entry');
                }
                
                // Test the condition logic
                const kacaData = firstLog.data.kacaData;
                if (kacaData) {
                    const hasData = Array.isArray(kacaData) ? 
                        kacaData.length > 0 : 
                        (kacaData.rows && kacaData.rows.length > 0);
                    
                    console.log('🔍 Condition check result:', hasData);
                    console.log('🔍 Array.isArray(kacaData):', Array.isArray(kacaData));
                    
                    if (Array.isArray(kacaData)) {
                        console.log('🔍 kacaData.length > 0:', kacaData.length > 0);
                    } else {
                        console.log('🔍 kacaData.rows exists:', !!kacaData.rows);
                        console.log('🔍 kacaData.rows.length > 0:', kacaData.rows && kacaData.rows.length > 0);
                    }
                }
                
            } else {
                console.log('❌ No log entries found');
            }
            
            // Check if loadKacaDataFromLog function exists
            console.log('🔍 loadKacaDataFromLog function exists:', typeof loadKacaDataFromLog === 'function');
            
            // Check if kaca table exists
            const tbody = document.getElementById('kacaTableBody');
            console.log('🔍 kacaTableBody exists:', !!tbody);
            
            console.log('🐛 Debug completed');
        }

        // Make debug function globally available
        window.debugAutoFillIssue = debugAutoFillIssue;

        // Function to toggle log details view
        function toggleLogDetails(index) {
            const defaultView = document.getElementById(`log-default-${index}`);
            const detailedView = document.getElementById(`log-detailed-${index}`);
            const logEntry = defaultView.closest('.log-entry');
            const toggleIcon = logEntry.querySelector('.log-toggle-icon');
            
            if (detailedView.style.display === 'none') {
                // Show detailed view
                defaultView.style.display = 'none';
                detailedView.style.display = 'block';
                toggleIcon.textContent = '📋';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                // Show default view
                defaultView.style.display = 'block';
                detailedView.style.display = 'none';
                toggleIcon.textContent = '📋';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }

        // Helper: find log index by unique id
        function findLogIndexById(logId) {
            return inputLogHistory.findIndex(entry => entry && entry.id === logId);
        }

        // Toggle by id (used after search rendering)
        function toggleLogDetailsById(logId) {
            const defaultView = document.getElementById(`log-default-${logId}`);
            const detailedView = document.getElementById(`log-detailed-${logId}`);
            if (!defaultView || !detailedView) return;
            const logEntry = defaultView.closest('.log-entry');
            const toggleIcon = logEntry ? logEntry.querySelector('.log-toggle-icon') : null;
            
            if (detailedView.style.display === 'none') {
                defaultView.style.display = 'none';
                detailedView.style.display = 'block';
                if (toggleIcon) {
                    toggleIcon.textContent = '📋';
                    toggleIcon.style.transform = 'rotate(180deg)';
                }
            } else {
                defaultView.style.display = 'block';
                detailedView.style.display = 'none';
                if (toggleIcon) {
                    toggleIcon.textContent = '📋';
                    toggleIcon.style.transform = 'rotate(0deg)';
                }
            }
        }

        // Wrappers by id to keep button actions working after filtering
        function loadInputFromLogById(logId) {
            const idx = findLogIndexById(logId);
            if (idx >= 0) loadInputFromLog(idx);
        }
        function editLogEntryById(logId) {
            const idx = findLogIndexById(logId);
            if (idx >= 0) editLogEntry(idx);
        }
        function deleteLogEntryById(logId) {
            const idx = findLogIndexById(logId);
            if (idx >= 0) deleteLogEntry(idx);
        }

        // Test function to verify new log display
        function testNewLogDisplay() {
            console.log('🧪 Testing New Log Display...');
            
            // Check if there are log entries
            if (inputLogHistory.length === 0) {
                console.log('❌ No log entries found. Please save a log first.');
                return;
            }
            
            console.log('✅ Log entries found:', inputLogHistory.length);
            
            // Check if new log structure exists
            const logEntries = document.querySelectorAll('.log-entry');
            console.log('📊 Number of log entries in DOM:', logEntries.length);
            
            if (logEntries.length > 0) {
                const firstLogEntry = logEntries[0];
                
                // Check for default view
                const defaultView = firstLogEntry.querySelector('.log-content-default');
                if (defaultView) {
                    console.log('✅ Default view found');
                    console.log('📊 Default view display:', defaultView.style.display);
                } else {
                    console.log('❌ Default view not found');
                }
                
                // Check for detailed view
                const detailedView = firstLogEntry.querySelector('.log-content-detailed');
                if (detailedView) {
                    console.log('✅ Detailed view found');
                    console.log('📊 Detailed view display:', detailedView.style.display);
                } else {
                    console.log('❌ Detailed view not found');
                }
                
                // Check for toggle icon
                const toggleIcon = firstLogEntry.querySelector('.log-toggle-icon');
                if (toggleIcon) {
                    console.log('✅ Toggle icon found');
                    console.log('📊 Toggle icon text:', toggleIcon.textContent);
                } else {
                    console.log('❌ Toggle icon not found');
                }
                
                // Check for load button in detailed view
                const loadButton = firstLogEntry.querySelector('.btn-load-data');
                if (loadButton) {
                    console.log('✅ Load button found in detailed view');
                } else {
                    console.log('❌ Load button not found');
                }
                
                // Test toggle functionality
                console.log('🔄 Testing toggle functionality...');
                const logIndex = 0; // Test with first log entry
                
                // Get initial state
                const initialDefaultDisplay = defaultView.style.display;
                const initialDetailedDisplay = detailedView.style.display;
                
                console.log('📊 Initial state:', {
                    default: initialDefaultDisplay,
                    detailed: initialDetailedDisplay
                });
                
                // Test toggle
                toggleLogDetails(logIndex);
                
                setTimeout(() => {
                    const afterToggleDefaultDisplay = defaultView.style.display;
                    const afterToggleDetailedDisplay = detailedView.style.display;
                    
                    console.log('📊 After toggle state:', {
                        default: afterToggleDefaultDisplay,
                        detailed: afterToggleDetailedDisplay
                    });
                    
                    if (afterToggleDefaultDisplay !== initialDefaultDisplay || 
                        afterToggleDetailedDisplay !== initialDetailedDisplay) {
                        console.log('✅ Toggle functionality working');
                    } else {
                        console.log('❌ Toggle functionality not working');
                    }
                    
                    // Toggle back
                    setTimeout(() => {
                        toggleLogDetails(logIndex);
                        console.log('🔄 Toggled back to original state');
                    }, 500);
                    
                }, 100);
                
            } else {
                console.log('❌ No log entries found in DOM');
            }
            
            console.log('🧪 New log display test completed');
        }

        // Make test function globally available
        window.testNewLogDisplay = testNewLogDisplay;

        // Test function to verify compact log display
        function testCompactLogDisplay() {
            console.log('🧪 Testing Compact Log Display...');
            
            // Check if there are log entries
            if (inputLogHistory.length === 0) {
                console.log('❌ No log entries found. Please save a log first.');
                return;
            }
            
            console.log('✅ Log entries found:', inputLogHistory.length);
            
            // Check if new compact structure exists
            const logEntries = document.querySelectorAll('.log-entry');
            console.log('📊 Number of log entries in DOM:', logEntries.length);
            
            if (logEntries.length > 0) {
                const firstLogEntry = logEntries[0];
                
                // Check for compact line
                const compactLine = firstLogEntry.querySelector('.log-compact-line');
                if (compactLine) {
                    console.log('✅ Compact line found');
                    
                    // Check compact items
                    const compactItems = compactLine.querySelectorAll('.log-compact-item');
                    console.log('📊 Number of compact items:', compactItems.length);
                    
                    compactItems.forEach((item, index) => {
                        const label = item.querySelector('.log-compact-label');
                        const value = item.querySelector('.log-compact-value');
                        
                        console.log(`📋 Compact item ${index + 1}:`, {
                            label: label ? label.textContent : 'not found',
                            value: value ? value.textContent : 'not found'
                        });
                    });
                    
                    // Check separators
                    const separators = compactLine.querySelectorAll('.log-compact-separator');
                    console.log('📊 Number of separators:', separators.length);
                    
                } else {
                    console.log('❌ Compact line not found');
                }
                
                // Check for default view
                const defaultView = firstLogEntry.querySelector('.log-content-default');
                if (defaultView) {
                    console.log('✅ Default view found');
                    console.log('📊 Default view display:', defaultView.style.display);
                } else {
                    console.log('❌ Default view not found');
                }
                
                // Check for detailed view
                const detailedView = firstLogEntry.querySelector('.log-content-detailed');
                if (detailedView) {
                    console.log('✅ Detailed view found');
                    console.log('📊 Detailed view display:', detailedView.style.display);
                } else {
                    console.log('❌ Detailed view not found');
                }
                
                // Test compact layout
                console.log('🔄 Testing compact layout...');
                
                // Check if layout is horizontal
                const computedStyle = window.getComputedStyle(compactLine);
                const flexDirection = computedStyle.flexDirection;
                console.log('📊 Flex direction:', flexDirection);
                
                if (flexDirection === 'row') {
                    console.log('✅ Compact layout is horizontal (desktop)');
                } else if (flexDirection === 'column') {
                    console.log('✅ Compact layout is vertical (mobile)');
                } else {
                    console.log('❌ Unexpected flex direction:', flexDirection);
                }
                
                // Test text overflow
                const compactValues = compactLine.querySelectorAll('.log-compact-value');
                compactValues.forEach((value, index) => {
                    const computedStyle = window.getComputedStyle(value);
                    const textOverflow = computedStyle.textOverflow;
                    const overflow = computedStyle.overflow;
                    const whiteSpace = computedStyle.whiteSpace;
                    
                    console.log(`📊 Text overflow for value ${index + 1}:`, {
                        textOverflow: textOverflow,
                        overflow: overflow,
                        whiteSpace: whiteSpace
                    });
                });
                
            } else {
                console.log('❌ No log entries found in DOM');
            }
            
            console.log('🧪 Compact log display test completed');
        }

        // Make test function globally available
        window.testCompactLogDisplay = testCompactLogDisplay;

        // Test function to verify container height matching
        function testContainerHeightMatching() {
            console.log('🧪 Testing Container Height Matching...');
            
            // Get container elements
            const leftSection = document.querySelector('.left-section');
            const rightSection = document.querySelector('.right-section');
            const mainLayout = document.querySelector('.main-layout');
            
            if (!leftSection || !rightSection || !mainLayout) {
                console.log('❌ Container elements not found');
                return;
            }
            
            console.log('✅ Container elements found');
            
            // Get computed styles
            const leftHeight = leftSection.offsetHeight;
            const rightHeight = rightSection.offsetHeight;
            const mainLayoutHeight = mainLayout.offsetHeight;
            
            console.log('📊 Container heights:', {
                leftSection: leftHeight + 'px',
                rightSection: rightHeight + 'px',
                mainLayout: mainLayoutHeight + 'px'
            });
            
            // Check if heights match
            const heightDifference = Math.abs(leftHeight - rightHeight);
            const tolerance = 10; // 10px tolerance for minor differences
            
            if (heightDifference <= tolerance) {
                console.log('✅ Container heights match (within tolerance)');
                console.log('📊 Height difference:', heightDifference + 'px');
            } else {
                console.log('❌ Container heights do not match');
                console.log('📊 Height difference:', heightDifference + 'px');
            }
            
            // Check flex properties
            const leftComputedStyle = window.getComputedStyle(leftSection);
            const rightComputedStyle = window.getComputedStyle(rightSection);
            const mainLayoutComputedStyle = window.getComputedStyle(mainLayout);
            
            console.log('📊 Flex properties:', {
                mainLayoutAlignItems: mainLayoutComputedStyle.alignItems,
                leftSectionFlex: leftComputedStyle.flex,
                rightSectionFlex: rightComputedStyle.flex,
                rightSectionDisplay: rightComputedStyle.display,
                rightSectionFlexDirection: rightComputedStyle.flexDirection
            });
            
            // Check if right section has flex column
            if (rightComputedStyle.display === 'flex' && rightComputedStyle.flexDirection === 'column') {
                console.log('✅ Right section has flex column layout');
            } else {
                console.log('❌ Right section does not have flex column layout');
            }
            
            // Check log container properties
            const logContainer = document.querySelector('.log-container');
            if (logContainer) {
                const logContainerComputedStyle = window.getComputedStyle(logContainer);
                console.log('📊 Log container properties:', {
                    flex: logContainerComputedStyle.flex,
                    minHeight: logContainerComputedStyle.minHeight,
                    overflowY: logContainerComputedStyle.overflowY
                });
            }
            
            // Check log actions properties
            const logActions = document.querySelector('.log-actions');
            if (logActions) {
                const logActionsComputedStyle = window.getComputedStyle(logActions);
                console.log('📊 Log actions properties:', {
                    marginTop: logActionsComputedStyle.marginTop,
                    flexShrink: logActionsComputedStyle.flexShrink
                });
            }
            
            // Test responsive behavior
            const isMobile = window.innerWidth <= 768;
            console.log('📱 Device type:', isMobile ? 'Mobile' : 'Desktop');
            
            if (isMobile) {
                console.log('📱 Mobile layout: Containers should stack vertically');
            } else {
                console.log('🖥️ Desktop layout: Containers should have matching heights');
            }
            
            console.log('🧪 Container height matching test completed');
        }

            // Make test function globally available
            window.testContainerHeightMatching = testContainerHeightMatching;

            // Toggle visibility of Log Input History section when header is clicked
            (function initLogHistoryToggle() {
                try {
                    const logHeader = document.querySelector('.right-section .log-header');
                    const logContainer = document.getElementById('inputLogContainer');
                    const logActions = document.querySelector('.right-section .log-actions');
                    const logHeaderActions = document.querySelector('.right-section .log-header-actions');
                    const rightSection = document.querySelector('.right-section');
                    if (!logHeader || !logContainer || !logActions) return;

                    // Indicate clickable header
                    logHeader.style.cursor = 'pointer';

                    let isLogExpanded = false;
                    const applyState = () => {
                        logContainer.style.display = isLogExpanded ? '' : 'none';
                        logActions.style.display = isLogExpanded ? 'flex' : 'none';
                        logHeader.setAttribute('aria-expanded', String(isLogExpanded));
                        // Ubah header menjadi satu baris saat collapsed (height kecil)
                        logHeader.style.marginBottom = isLogExpanded ? '8px' : '2px';
                        // Tampilkan juga tombol di header ketika expanded, tetap tampil saat collapsed
                        if (logHeaderActions) {
                            logHeaderActions.style.opacity = isLogExpanded ? '1' : '0.9';
                        }
                    };
                    applyState();

                    const toggle = () => {
                        isLogExpanded = !isLogExpanded;
                        applyState();
                    };

                    logHeader.addEventListener('click', (e) => {
                        // Prevent toggle when interacting with controls inside header (search input, buttons)
                        const target = e.target;
                        if (target && (target.closest('.log-header-actions') || target.tagName === 'INPUT' || target.tagName === 'BUTTON')) {
                            return;
                        }
                        toggle();
                    });
                    logHeader.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggle();
                        }
                    });
                } catch (error) {
                    console.error('Failed to initialize Log Input History toggle:', error);
                }
            })();

            // Toggle FAB for showing/hiding log action buttons
            function toggleLogFab(btn) {
                try {
                    const section = btn.closest('.right-section');
                    if (!section) return;
                    const isOpen = section.classList.toggle('log-fab-open');
                    // Optionally focus search when opening
                    if (isOpen) {
                        const search = section.querySelector('#logSearchInput');
                        if (search) search.focus();
                    }
                } catch (error) {
                    console.error('Failed to toggle log FAB:', error);
                }
            }
    </script>
</body>
</html>
